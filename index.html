<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Production Dashboard</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { background: #111; color: white; font-family: sans-serif; text-align: center; margin: 0; padding: 10px; }
        #reader { width: 100%; max-width: 500px; margin: auto; border-radius: 10px; overflow: hidden; background: #000; }
        .qr-item { background: #222; border: 1px solid #444; margin: 10px auto; padding: 15px; border-radius: 10px; max-width: 450px; text-align: left; }
        .btn { padding: 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; width: 100%; margin-top: 10px; font-size: 16px; }
        .btn-share { background: #007bff; }
        .btn-start { background: #28a745; margin-bottom: 15px; }
        input[type="password"] { padding: 12px; background: #333; border: 1px solid #555; color: white; border-radius: 8px; width: 90%; margin: 10px 0; }
        .hidden { display: none; }
        code { background: #000; padding: 4px; color: #0f0; word-break: break-all; font-family: monospace; }
    </style>
</head>
<body>

    <h1>ðŸ“‹ QR Dashboard</h1>

    <div id="gate">
        <input type="password" id="pinInput" placeholder="Enter PIN (e.g. 2626)">
        <button class="btn btn-start" onclick="initApp()">Lock PIN & Access</button>
    </div>

    <div id="app" class="hidden">
        <div id="reader"></div>
        <button id="cameraBtn" class="btn btn-start" onclick="startOneShotScan()">ðŸ“· Scan QR Code</button>
        <div id="history"></div>
    </div>

    <script>
        const AUTH_KEY = 'qr_prod_pin';
        const HIST_KEY = 'qr_prod_history';
        let html5QrCode = null;

        function initApp() {
            const pin = document.getElementById('pinInput').value;
            if (pin) {
                localStorage.setItem(AUTH_KEY, pin);
                document.getElementById('gate').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                render();
            }
        }

        /**
         * PRODUCTION ONE-SHOT SCANNER
         * Starts camera, scans one item, then immediately kills the stream.
         */
        function startOneShotScan() {
            const cameraBtn = document.getElementById('cameraBtn');
            cameraBtn.disabled = true;
            cameraBtn.innerText = "Camera Active...";

            html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 15, qrbox: { width: 250, height: 250 } };

            html5QrCode.start({ facingMode: "environment" }, config, (decodedText) => {
                // SUCCESS: Immediately stop the scanner (The "Stop" logic you requested)
                html5QrCode.stop().then(() => {
                    html5QrCode = null;
                    cameraBtn.disabled = false;
                    cameraBtn.innerText = "ðŸ“· Scan Next QR";
                    
                    if (navigator.vibrate) navigator.vibrate(100);
                    saveScan(decodedText);
                });
            }).catch(err => {
                cameraBtn.disabled = false;
                cameraBtn.innerText = "ðŸ“· Retry Scanner";
                console.error("Camera Error:", err);
            });
        }

        function saveScan(text) {
            let history = JSON.parse(localStorage.getItem(HIST_KEY) || "[]");
            // Add new scan to top of list
            history.unshift({ text, date: new Date().toLocaleString() });
            // Limit to last 10 entries
            localStorage.setItem(HIST_KEY, JSON.stringify(history.slice(0, 10)));
            render();
        }

        function render() {
            const container = document.getElementById('history');
            const items = JSON.parse(localStorage.getItem(HIST_KEY) || "[]");
            container.innerHTML = items.length ? "" : "<p>No recent scans.</p>";

            items.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'qr-item';
                div.innerHTML = `
                    <div style="font-size:0.8em; color:#888;">${item.date}</div>
                    <div style="margin:5px 0;"><b>Data:</b> <code>${item.text}</code></div>
                    <button class="btn btn-share" onclick="sendToKde(${idx})">ðŸ“¤ Share to KDE</button>
                `;
                container.appendChild(div);
            });
        }

        /**
         * KDE TRANSMISSION PROTOCOL
         * Exact match for your Bash listener: Line 1 = Data, Line 2 = PIN
         */
        async function sendToKde(idx) {
            const items = JSON.parse(localStorage.getItem(HIST_KEY));
            const entry = items[idx];
            const pin = localStorage.getItem(AUTH_KEY);

            const payload = `${entry.text}\nPIN: ${pin}`;
            const fileName = `qr_share_${Date.now()}.txt`;

            if (navigator.share) {
                try {
                    const file = new File([payload], fileName, { type: 'text/plain' });
                    await navigator.share({ files: [file], title: 'QR Data' });
                } catch (e) { /* Share cancelled */ }
            } else {
                // Force download if Share API fails
                const blob = new Blob([payload], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                a.click();
            }
        }

        // Auto-login logic
        if (localStorage.getItem(AUTH_KEY)) {
            document.getElementById('gate').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            render();
        }
    </script>
</body>
</html>
