<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QR Actions Pro - Ultimate</title>
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlFSIEFjdGlvbnMgUHJvIiwKICAic2hvcnRfbmFtZSI6ICJRUkFjdGlvbnMiLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiIzEyMTIxMiIsCiAgInRoZW1lX2NvbG9yIjogIiMxMjEyMTIiLAogICJpY29ucyI6IFt7CiAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjRiV3h1Y3owaWFIUjBjRG92TDNkM2R5NTNNeTV2Y21jdk1qQXdNQzl6ZG1jaUlIQnlaWE5sY25abFFYTndaV04wU1M1d2FHRWlJSFpwWlhkQ2IzZzlJakFnTUNBek5UQWlJSE4wZVd4bFBTSnVZVzFsSWo0OGNHRjBhQ0JrUFNKTk1UQXhJREV4TUN3Mk1UazdNVEk3TFRJMExUQTRMVEUwTFRFeE9pNDBMakF1TkM0MExqY3VNVEl1TVRBdU1UQXVOelF1TlRNN0lEQXVNREF1TURBdU1EQXBJajQ4ZEdWNGRDQmtQU0pOTVRBeElERXhNQ3cyTVRrN01USTdMVEkwTFRBNExURTBMVEV4T2k0MExqQXVOQzQwTGpjdU1USXVNVEF1TVRBdU56UXVOVE03SURBdU1EQXVNREF1TURBcElqNDhkR1Y0ZENCa1BTSk5NVEF4SURFeE1DdzJNVGs3TVRJN0xUSTBMVEE0TFRFMExURXhPaTQwTGpBdU5DNDBMamN1TVRJdU1UQXVNVEF1TnpRdU5UTTdJREF1TURBdU1EQXVNREFwSWo0OGNHRjBhQ0JrUFNKTk1UQXhJREV4TUN3Mk1UazdNVEk3TFRJMExUQTRMVEUwTFRFeE9pNDBMakF1TkM0MExqY3VNVEl1TVRBdU1UQXVOelF1TlRNN0lEQXVNREF1TURBdU1EQXBJajQ4ZEdWNGRDQmtQU0pOTVRBeElERXhNQ3cyTVRrN01USTdMVEkwTFRBNExURTBMVEV4T2k0MExqQXVOQzQwTGpjdU1USXVNVEF1TVRBdU56UXVOVE03SURBdU1EQXVNREF1TURBcElqNDhkR1Y0ZENCa1BTSk5NVEF4SURFeE1DdzJNVGs3TVRJN0xUSTBMVEE0TFRFMExURXhPaTQwTGpBdU5DNDBMamN1TVRJdU1UQXVNVEF1TnpRdU5UTTdJREF1TURBdU1EQXVNREFwSWo0OEwzQmhkR2d2YkdsdVpTOU1aVzVuZEdnK1BITjVjM1JsYlNCa1BTSk5NVEF4SURFeE1DdzJNVGs3TVRJN0xUSTBMVEE0TFRFMExURXhPaTQwTGpBdU5DNDBMamN1TVRJdU1UQXVNVEF1TnpRdU5UTTdJREF1TURBdU1EQXVNREFwSWo0OGNHRjBhQ0JrUFNKTk1UQXhJREV4TUN3Mk1UazdNVEk3TFRJMExUQTRMVEUwTFRFeE9pNDBMakF1TkM0MExqY3VNVEl1TVRBdU1UQXVOelF1TlRNN0lEQXVNREF1TURBdU1EQXBJajQ4ZEdWNGRDQmtQU0pOTVRBeElERXhNQ3cyTVRrN01USTdMVEkwTFRBNExURTBMVEV4T2k0MExqQXVOQzQwTGpjdU1USXVNVEF1TVRBdU56UXVOVE03SURBdU1EQXVNREF1TURBcElqNDhkR1Y0ZENCa1BTSk5NVEF4SURFeE1DdzJNVGs3TVRJN0xUSTBMVEE0TFRFMExURXhPaTQwTGpBdU5DNDBMamN1TVRJdU1UQXVNVEF1TnpRdU5UTTdJREF1TURBdU1EQXVNREFwSWo0OEwzQmhkR2d2YkdsdVpTOU1aVzVuZEdnK1BIQmhkR2dnWkQwaVRUVTRNaUJETlRJN0xUSXdMVEUyTFRFeUxUSXdMVEUwTFRJeExURTJNQzR3TGpRdU5DNHdMakV1TlM0d0xqSXVOaTQwTGpFN0lEQXVNREF1TURBdU1EQXBJajQ4ZEdWNGRDQmtQU0pOTVRBeElERXhNQ3cyTVRrN01USTdMVEkwTFRBNExURTBMVEV4T2k0MExqQXVOQzQwTGpjdU1USXVNVEF1TVRBdU56UXVOVE03SURBdU1EQXVNREF1TURBcElqNDhkR1Y0ZENCa1BTSk5NVEF4SURFeE1DdzJNVGs3TVRJN0xUSTBMVEE0TFRFMExURXhPaTQwTGpBdU5DNDBMamN1TVRJdU1UQXVNVEF1TnpRdU5UTTdJREF1TURBdU1EQXVNREFwSWo0OGNHRjBhQ0JrUFNKTk1UQXhJREV4TUN3Mk1UazdNVEk3TFRJMExUQTRMVEUwTFRFeE9pNDBMakF1TkM0MExqY3VNVEl1TVRBdU1UQXVOelF1TlRNN0lEQXVNREF1TURBdU1EQXBJajQ4ZEdWNGRDQmtQU0pOTVRBeElERXhNQ3cyTVRrN01USTdMVEkwTFRBNExURTBMVEV4T2k0MExqQXVOQzQwTGpjdU1USXVNVEF1TVRBdU56UXVOVE03SURBdU1EQXVNREF1TURBcElqNDhkR1Y0ZENCa1BTSk5NVEF4SURFeE1DdzJNVGs3TVRJN0xUSTBMVEE0TFRFMExURXhPaTQwTGpBdU5DNDBMamN1TVRJdU1UQXVNVEF1TnpRdU5UTTdJREF1TURBdU1EQXVNREFwSWo0OEwzQmhkR2d2YkdsdVpTOU1aVzVuZEdnK1BITjVjM1JsYlNCa1BTSk5NVEF4SURFeE1DdzJNVGs3TVRJN0xUSTBMVEE0TFRFMExURXhPaTQwTGpBdU5DNDBMamN1TVRJdU1UQXVNVEF1TnpRdU5UTTdJREF1TURBdU1EQXVNREFwSWo0OGNHRjBhQ0JrUFNKTk1UQXhJREV4TUN3Mk1UazdNVEk3TFRJMExUQTRMVEUwTFRFeE9pNDBMakF1TkM0MExqY3VNVEl1TVRBdU1UQXVOelF1TlRNN0lEQXVNREF1TURBdU1EQXBJajQ4ZEdWNGRDQmtQU0pOTVRBeElERXhNQ3cyTVRrN01USTdMVEkwTFRBNExURTBMVEV4T2k0MExqQXVOQzQwTGpjdU1USXVNVEF1TVRBdU56UXVOVE03SURBdU1EQXVNREF1TURBcElqNDhkR1Y0ZENCa1BTSk5NVEF4SURFeE1DdzJNVGs3TVRJN0xUSTBMVEE0TFRFMExURXhPaTQwTGpBdU5DNDBMamN1TVRJdU1UQXVNVEF1TnpRdU5UTTdJREF1TURBdU1EQXVNREFwSWo0OEwzQmhkR2d2YkdsdVpTOU1aVzVuZEdnK1BIQmhkR2dnWkQwaVRUVTRNaUJETlRJN0xUSXdMVEUyTFRFeUxUSXdMVEUwTFRJeExURTJNQzR3TGpRdU5DNHdMakV1TlM0d0xqSXVOaTQwTGpFN0lEQXVNREF1TURBdU1EQXBJajQ4ZEdWNGRDQmtQU0pOTVRBeElERXhNQ3cyTVRrN01USTdMVEkwTFRBNExURTBMVEV4T2k0MExqQXVOQzQwTGpjdU1USXVNVEF1TVRBdU56UXVOVE03SURBdU1EQXVNREF1TURBcElqNDhkR1Y0ZENCa1BTSk5NVEF4SURFeE1DdzJNVGs3TVRJN0xUSTBMVEE0TFRFMExURXhPaTQwTGpBdU5DNDBMamN1TVRJdU1UQXVNVEF1TnpRdU5UTTdJREF1TURBdU1EQXVNREFwSWo0OGNHRjBhQ0JrUFNKTk1UQXhJREV4TUN3Mk1UazdNVEk3TFRJMExUQTRMVEUwTFRFeE9pNDBMakF1TkM0MExqY3VNVEl1TVRBdU1UQXVOelF1TlRNN0lEQXVNREF1TURBdU1EQXBJajQ4ZEdWNGRDQmtQU0pOTVRBeElERXhNQ3cyTVRrN01USTdMVEkwTFRBNExURTBMVEV4T2k0MExqQXVOQzQwTGpjdU1USXVNVEF1TVRBdU56UXVOVE03SURBdU1EQXVNREF1TURBcElqNDhkR1Y0ZENCa1BTSk5NVEF4SURFeE1DdzJNVGs3TVRJN0xUSTBMVEE0TFRFMExURXhPaTQwTGpBdU5DNDBMamN1TVRJdU1UQXVNVEF1TnpRdU5UTTdJREF1TURBdU1EQXVNREFwSWo0OEwzQmhkR2d2YkdsdVpTOU1aVzVuZEdnK1BDOXpkbWMrIiwKICAgICJzaXplcyI6ICIxOTJ4MTkyIiwKICAgICJ0eXBlIjogImltYWdlL3BuZyIKICB9XQp9">
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <style>
        :root {
            --bg: #121212;
            --card: #1e1e1e;
            --accent: #007bff;
            --green: #28a745;
            --red: #dc3545;
            --yellow: #ffc107;
            --purple: #6f42c1;
            --orange: #fd7e14;
            --teal: #20c997;
            --cyan: #17a2b8;
            --grey: #444;
            --dark-grey: #2a2a2a;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            background: var(--bg);
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            margin: 0;
            padding: 10px;
            text-align: center;
            line-height: 1.4;
        }
        
        /* Header & Navigation */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            max-width: 500px;
            margin: 0 auto 15px auto;
            position: sticky;
            top: 0;
            z-index: 50;
            background: rgba(18, 18, 18, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 1px solid #333;
        }
        
        .app-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0;
            font-size: 1.4rem;
        }
        
        .stats-badge {
            background: var(--accent);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 8px;
        }
        
        .nav-tabs {
            display: flex;
            justify-content: space-around;
            max-width: 500px;
            margin: 0 auto 20px auto;
            background: var(--dark-grey);
            border-radius: 12px;
            padding: 5px;
            border: 1px solid #333;
        }
        
        .tab-btn {
            flex: 1;
            padding: 14px;
            background: transparent;
            border: none;
            color: #aaa;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .tab-btn.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }
        
        /* Main Scanner */
        #reader {
            width: 100%;
            max-width: 500px;
            margin: 0 auto 20px auto;
            border-radius: 16px;
            overflow: hidden;
            background: #000;
            min-height: 280px;
            border: 2px solid #333;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }
        
        /* Action Buttons */
        .action-row {
            display: flex;
            gap: 10px;
            max-width: 500px;
            margin: 0 auto 15px auto;
        }
        
        .btn {
            padding: 16px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            color: white;
            width: 100%;
            margin-top: 8px;
            font-size: 15px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-scan {
            background: linear-gradient(135deg, var(--green), #1e7e34);
            flex: 2;
            margin-top: 0;
        }
        
        .btn-upload {
            background: linear-gradient(135deg, var(--grey), #2a2a2a);
            flex: 1;
            margin-top: 0;
            position: relative;
            overflow: hidden;
        }
        
        .btn-upload input {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
            height: 100%;
            width: 100%;
        }
        
        .btn-generate {
            background: linear-gradient(135deg, var(--purple), #5a32a3);
            margin-top: 0;
        }
        
        .btn-batch {
            background: linear-gradient(135deg, var(--orange), #e95e00);
            margin-top: 0;
        }
        
        .btn-abort {
            background: linear-gradient(135deg, var(--red), #c82333);
            margin-bottom: 15px;
            display: none;
        }
        
        .btn-share {
            background: linear-gradient(135deg, var(--accent), #0056b3);
        }
        
        .btn-copy {
            background: linear-gradient(135deg, var(--cyan), #138496);
        }
        
        .btn-favorite {
            background: linear-gradient(135deg, var(--yellow), #e0a800);
            color: #212529;
        }
        
        .btn-delete {
            background: linear-gradient(135deg, #6c757d, #545b62);
        }
        
        .btn-email {
            background: linear-gradient(135deg, var(--teal), #179b7d);
        }
        
        .btn-phone {
            background: linear-gradient(135deg, #6610f2, #5300d6);
        }
        
        .btn-maps {
            background: linear-gradient(135deg, #dc3545, #bd2130);
        }
        
        .btn-crypto {
            background: linear-gradient(135deg, #f7931a, #e68516);
            color: white;
        }
        
        .btn-calendar {
            background: linear-gradient(135deg, #20c997, #199d76);
        }
        
        /* Card Styling */
        .qr-card {
            background: var(--card);
            border: 1px solid #333;
            padding: 20px;
            margin: 15px auto;
            max-width: 500px;
            border-radius: 14px;
            text-align: left;
            position: relative;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .qr-card.highlight {
            animation: highlight 1.5s ease;
            border-color: var(--green);
        }
        
        .qr-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .qr-type-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-url { background: rgba(40, 167, 69, 0.2); color: #28a745; border: 1px solid rgba(40, 167, 69, 0.3); }
        .badge-wifi { background: rgba(108, 117, 125, 0.2); color: #6c757d; border: 1px solid rgba(108, 117, 125, 0.3); }
        .badge-text { background: rgba(0, 123, 255, 0.2); color: #007bff; border: 1px solid rgba(0, 123, 255, 0.3); }
        .badge-email { background: rgba(111, 66, 193, 0.2); color: #6f42c1; border: 1px solid rgba(111, 66, 193, 0.3); }
        .badge-tel { background: rgba(23, 162, 184, 0.2); color: #17a2b8; border: 1px solid rgba(23, 162, 184, 0.3); }
        .badge-sms { background: rgba(32, 201, 151, 0.2); color: #20c997; border: 1px solid rgba(32, 201, 151, 0.3); }
        .badge-geo { background: rgba(220, 53, 69, 0.2); color: #dc3545; border: 1px solid rgba(220, 53, 69, 0.3); }
        .badge-vcard { background: rgba(255, 193, 7, 0.2); color: #ffc107; border: 1px solid rgba(255, 193, 7, 0.3); }
        .badge-calendar { background: rgba(253, 126, 20, 0.2); color: #fd7e14; border: 1px solid rgba(253, 126, 20, 0.3); }
        .badge-crypto { background: rgba(247, 147, 26, 0.2); color: #f7931a; border: 1px solid rgba(247, 147, 26, 0.3); }
        .badge-barcode { background: rgba(134, 142, 150, 0.2); color: #868e96; border: 1px solid rgba(134, 142, 150, 0.3); }
        .badge-whatsapp { background: rgba(37, 211, 102, 0.2); color: #25d366; border: 1px solid rgba(37, 211, 102, 0.3); }
        
        .favorite-btn {
            background: none;
            border: none;
            color: #666;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s;
            padding: 5px;
        }
        
        .favorite-btn.active {
            color: var(--yellow);
            text-shadow: 0 0 10px rgba(255, 193, 7, 0.5);
        }
        
        .delete-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid rgba(220, 53, 69, 0.3);
            color: #666;
            font-size: 14px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .delete-btn:hover {
            background: rgba(220, 53, 69, 0.2);
            color: var(--red);
        }
        
        .qr-date {
            font-size: 0.8em;
            color: #888;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .qr-content {
            margin-bottom: 20px;
            padding-right: 45px;
            line-height: 1.5;
        }
        
        .qr-preview {
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border: 1px solid #333;
        }
        
        .wifi-pass {
            filter: blur(5px);
            transition: filter 0.3s;
            cursor: pointer;
            background: #333;
            padding: 6px 12px;
            border-radius: 6px;
            font-family: monospace;
            display: inline-block;
            margin: 5px 0;
        }
        
        .wifi-pass.show {
            filter: blur(0);
        }
        
        .contact-info {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
        }
        
        .contact-field {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 8px 0;
        }
        
        .contact-field i {
            color: var(--accent);
            width: 20px;
            text-align: center;
        }
        
        /* Action Buttons Grid */
        .qr-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn-small {
            padding: 12px;
            font-size: 13px;
            gap: 6px;
        }
        
        /* Search & Filter */
        .search-container {
            max-width: 500px;
            margin: 0 auto 20px auto;
            position: relative;
        }
        
        .search-input {
            padding: 15px 50px 15px 20px;
            background: #222;
            border: 1px solid #333;
            border-radius: 12px;
            color: white;
            font-size: 15px;
            width: 100%;
            transition: all 0.2s;
        }
        
        .search-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }
        
        .search-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #888;
            font-size: 18px;
        }
        
        .filter-tabs {
            display: flex;
            gap: 8px;
            max-width: 500px;
            margin: 0 auto 20px auto;
            overflow-x: auto;
            padding-bottom: 8px;
            flex-wrap: wrap;
        }
        
        .filter-tabs::-webkit-scrollbar {
            height: 4px;
        }
        
        .filter-tab {
            padding: 10px 18px;
            background: var(--dark-grey);
            border: 1px solid #333;
            color: #aaa;
            border-radius: 20px;
            font-size: 13px;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .filter-tab.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }
        
        /* Settings & Generate Overlays */
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.97);
            z-index: 1000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            padding: 20px;
            backdrop-filter: blur(10px);
        }
        
        .overlay-content {
            background: #222;
            padding: 30px;
            border-radius: 20px;
            width: 95%;
            max-width: 450px;
            border: 1px solid #444;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        
        .settings-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #333;
        }
        
        .settings-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .settings-section h4 {
            margin: 0 0 15px 0;
            color: #ddd;
            font-size: 17px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* QR Code Display */
        #qrCodeDisplay {
            margin: 25px auto;
            background: white;
            padding: 25px;
            border-radius: 16px;
            max-width: 280px;
            border: 2px solid #444;
        }
        
        /* Inputs & Selects */
        input, select, textarea {
            padding: 14px;
            background: #333;
            color: white;
            border: 1px solid #555;
            border-radius: 10px;
            width: 100%;
            box-sizing: border-box;
            margin: 8px 0 20px 0;
            font-size: 16px;
            transition: all 0.2s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }
        
        label {
            font-size: 13px;
            color: #aaa;
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        /* Batch Scan */
        .batch-counter {
            background: var(--accent);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin: 15px auto;
            display: inline-block;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--green);
            color: white;
            padding: 16px 28px;
            border-radius: 12px;
            font-weight: 600;
            z-index: 2000;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            max-width: 90%;
            text-align: center;
            display: flex;
            align-items: center;
            gap: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
        }
        
        .toast.error {
            background: linear-gradient(135deg, var(--red), #bd2130);
        }
        
        .toast.warning {
            background: linear-gradient(135deg, var(--yellow), #e0a800);
            color: #212529;
        }
        
        .toast.info {
            background: linear-gradient(135deg, var(--cyan), #138496);
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.2;
        }
        
        .empty-text {
            font-size: 16px;
            color: #888;
            margin-top: 10px;
        }
        
        /* Footer */
        .footer {
            margin-top: 50px;
            padding: 30px 20px;
            border-top: 1px solid #333;
            font-size: 14px;
            color: #888;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .footer-links {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .footer a {
            color: var(--accent);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
        }
        
        .footer a:hover {
            color: #0056b3;
            text-decoration: underline;
        }
        
        /* Animations */
        @keyframes highlight {
            0% { background: rgba(40, 167, 69, 0.3); border-color: var(--green); }
            100% { background: var(--card); border-color: #333; }
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Responsive */
        @media (max-width: 500px) {
            .btn {
                padding: 14px;
                font-size: 14px;
            }
            
            .qr-actions {
                grid-template-columns: 1fr 1fr;
            }
            
            .header {
                border-radius: 0;
                top: 0;
            }
            
            .overlay-content {
                padding: 20px;
                border-radius: 16px;
            }
        }
        
        /* QR Code Scanner Indicator */
        .scanner-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 2px solid var(--green);
            border-radius: 10px;
            pointer-events: none;
            animation: scan 2s infinite linear;
            z-index: 5;
        }
        
        @keyframes scan {
            0%, 100% { top: 20%; }
            50% { top: 80%; }
        }
        
        /* Checkbox & Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            margin: 0 10px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #333;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--accent);
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        /* Quick Actions Menu */
        .quick-actions {
            display: flex;
            gap: 10px;
            max-width: 500px;
            margin: 0 auto 20px auto;
            flex-wrap: wrap;
        }
        
        .quick-action-btn {
            flex: 1;
            min-width: 100px;
            padding: 12px;
            background: var(--dark-grey);
            border: 1px solid #333;
            border-radius: 10px;
            color: #ddd;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }
        
        .quick-action-btn:hover {
            background: #333;
            transform: translateY(-2px);
        }
        
        .quick-action-btn i {
            font-size: 24px;
        }
    </style>
</head>
<body>

    <!-- Header -->
    <div class="header">
        <h1 class="app-title">üìã QR Actions Pro
            <span class="stats-badge" id="statsBadge">0</span>
        </h1>
        <button class="settings-icon" onclick="toggleSettings()" style="font-size:28px;">‚öôÔ∏è</button>
    </div>
    
    <!-- Navigation Tabs -->
    <div class="nav-tabs">
        <button class="tab-btn active" onclick="switchTab('scan')">
            <span>üîç</span> Scan
        </button>
        <button class="tab-btn" onclick="switchTab('history')">
            <span>üìú</span> History
            <span class="stats-badge" style="background:var(--green); font-size:10px;" id="historyCount">0</span>
        </button>
        <button class="tab-btn" onclick="switchTab('favorites')">
            <span>‚≠ê</span> Favorites
            <span class="stats-badge" style="background:var(--yellow); color:#212529; font-size:10px;" id="favoritesCount">0</span>
        </button>
        <button class="tab-btn" onclick="switchTab('batch')">
            <span>üì¶</span> Batch
            <span class="stats-badge" style="background:var(--orange); font-size:10px;" id="batchCount">0</span>
        </button>
    </div>
    
    <!-- Quick Actions -->
    <div class="quick-actions">
        <button class="quick-action-btn" onclick="copyAllHistory()">
            <span>üìã</span>
            Copy All
        </button>
        <button class="quick-action-btn" onclick="exportHistory()">
            <span>üì§</span>
            Export
        </button>
        <button class="quick-action-btn" onclick="clearOldScans()">
            <span>üßπ</span>
            Cleanup
        </button>
        <button class="quick-action-btn" onclick="toggleGenerateQR()">
            <span>üîÑ</span>
            Generate
        </button>
    </div>
    
    <!-- Scan Tab Content -->
    <div id="scanTab" class="tab-content">
        <div id="reader"></div>
        
        <div class="action-row" id="mainActions">
            <button id="cameraBtn" class="btn btn-scan" onclick="startScan()">
                <span>üì∑</span> Scan QR Code
            </button>
            <div class="btn btn-upload">
                <span>üìÅ</span> Upload Image
                <input type="file" id="qr-input-file" accept="image/*" onchange="uploadImage(event)">
            </div>
        </div>
        
        <button id="abortBtn" class="btn btn-abort" onclick="stopScan()">
            <span>üõë</span> Stop Scanning
        </button>
        
        <div class="action-row">
            <button class="btn btn-batch" onclick="startBatchScan()">
                <span>üì¶</span> Batch Scan
            </button>
            <button class="btn btn-generate" onclick="toggleGenerateQR()">
                <span>üîÑ</span> Generate QR
            </button>
        </div>
    </div>
    
    <!-- History Tab Content -->
    <div id="historyTab" class="tab-content" style="display:none;">
        <div class="search-container">
            <input type="text" class="search-input" id="searchInput" placeholder="Search history..." oninput="filterHistory()">
            <span class="search-icon">üîç</span>
        </div>
        
        <div class="filter-tabs">
            <button class="filter-tab active" onclick="setFilter('all')">All</button>
            <button class="filter-tab" onclick="setFilter('url')">
                <span>üåê</span> URLs
            </button>
            <button class="filter-tab" onclick="setFilter('wifi')">
                <span>üì∂</span> WiFi
            </button>
            <button class="filter-tab" onclick="setFilter('text')">
                <span>üìù</span> Text
            </button>
            <button class="filter-tab" onclick="setFilter('contact')">
                <span>üë§</span> Contacts
            </button>
            <button class="filter-tab" onclick="setFilter('email')">
                <span>üìß</span> Email
            </button>
            <button class="filter-tab" onclick="setFilter('phone')">
                <span>üìû</span> Phone
            </button>
            <button class="filter-tab" onclick="setFilter('crypto')">
                <span>‚Çø</span> Crypto
            </button>
            <button class="filter-tab" onclick="setFilter('favorites')">
                <span>‚≠ê</span> Favorites
            </button>
        </div>
        
        <div id="history"></div>
    </div>
    
    <!-- Favorites Tab Content -->
    <div id="favoritesTab" class="tab-content" style="display:none;">
        <div class="search-container">
            <input type="text" class="search-input" id="favoritesSearch" placeholder="Search favorites..." oninput="filterFavorites()">
            <span class="search-icon">üîç</span>
        </div>
        
        <div id="favorites"></div>
    </div>
    
    <!-- Batch Scan Tab Content -->
    <div id="batchTab" class="tab-content" style="display:none;">
        <div id="batchReader"></div>
        
        <div class="batch-counter" id="batchCounter" style="display:none;">
            Scanned: <span id="batchScanned">0</span> items
        </div>
        
        <div class="action-row">
            <button class="btn btn-scan" onclick="startBatchMode()">
                <span>üì¶</span> Start Batch Scan
            </button>
            <button class="btn btn-abort" onclick="stopBatchMode()" style="display:none;">
                <span>üõë</span> Stop Batch
            </button>
        </div>
        
        <button class="btn btn-share" onclick="exportBatchData()" style="display:none;">
            <span>üì§</span> Export Batch Data
        </button>
        
        <div id="batchResults"></div>
    </div>
    
    <!-- Settings Overlay -->
    <div id="settingsOverlay" class="overlay">
        <div class="overlay-content">
            <h3 style="margin-top:0; display:flex; align-items:center; gap:10px;">
                <span>‚öôÔ∏è</span> Settings
            </h3>
            
            <div class="settings-section">
                <h4><span>üì∑</span> Camera Settings</h4>
                <label>Preferred Camera</label>
                <select id="cameraSelect">
                    <option value="">Default (Environment)</option>
                </select>
                
                <label style="margin-top: 15px;">
                    <input type="checkbox" id="continuousScan" style="width: auto; margin-right: 10px;">
                    Continuous Scan Mode
                </label>
                
                <label style="margin-top: 10px;">
                    <input type="checkbox" id="beepOnScan" style="width: auto; margin-right: 10px;">
                    Beep on Successful Scan
                </label>
            </div>
            
            <div class="settings-section">
                <h4><span>üìú</span> History Settings</h4>
                <label>History Limit (0 = Unlimited)</label>
                <input type="number" id="limitInput" min="0" value="50">
                
                <label style="margin-top: 15px;">Auto-delete after (days, 0 = never)</label>
                <input type="number" id="autoDeleteInput" min="0" value="30">
                
                <label style="margin-top: 15px;">
                    <input type="checkbox" id="saveToCloud" style="width: auto; margin-right: 10px;">
                    Backup to iCloud/Google Drive
                </label>
            </div>
            
            <div class="settings-section">
                <h4><span>üîí</span> Security Settings</h4>
                <label>Transmission PIN</label>
                <input type="password" id="pinInput" placeholder="Optional PIN for sharing">
                
                <label style="margin-top: 15px;">
                    <input type="checkbox" id="safeBrowsingCheck" style="width: auto; margin-right: 10px;" checked>
                    Enable safe browsing warnings
                </label>
                
                <label style="margin-top: 10px;">
                    <input type="checkbox" id="maskSensitiveData" style="width: auto; margin-right: 10px;" checked>
                    Mask sensitive data by default
                </label>
            </div>
            
            <div class="settings-section">
                <h4><span>üé®</span> Appearance</h4>
                <label>Theme</label>
                <select id="themeSelect">
                    <option value="dark">Dark</option>
                    <option value="light">Light</option>
                    <option value="auto">Auto</option>
                </select>
                
                <label style="margin-top: 15px;">QR Preview Size</label>
                <select id="previewSize">
                    <option value="small">Small</option>
                    <option value="medium" selected>Medium</option>
                    <option value="large">Large</option>
                </select>
            </div>
            
            <div class="settings-section">
                <h4><span>‚ö°</span> Quick Actions</h4>
                <label>Default action for URLs</label>
                <select id="defaultUrlAction">
                    <option value="visit">Visit in browser</option>
                    <option value="safety">Check safety first</option>
                    <option value="ask">Always ask</option>
                </select>
                
                <label style="margin-top: 15px;">Default action for WiFi</label>
                <select id="defaultWifiAction">
                    <option value="show">Show password</option>
                    <option value="copy">Copy to clipboard</option>
                    <option value="ask">Always ask</option>
                </select>
            </div>
            
            <button class="btn btn-share" onclick="saveSettings()" style="margin-top: 20px;">
                <span>üíæ</span> Save Settings
            </button>
            
            <button class="btn btn-danger" onclick="clearAllData()" style="margin-top: 10px;">
                <span>‚ö†Ô∏è</span> Clear All Data
            </button>
            
            <button class="btn" style="background:transparent; margin-top: 10px;" onclick="toggleSettings()">
                Cancel
            </button>
            
            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #333; font-size: 12px; color: #666; text-align: center;">
                QR Actions Pro v2.5 ‚Ä¢ Works offline ‚Ä¢ By Bram Diederik
            </div>
        </div>
    </div>
    
    <!-- Generate QR Overlay -->
    <div id="generateOverlay" class="overlay">
        <div class="overlay-content">
            <h3 style="margin-top:0; display:flex; align-items:center; gap:10px;">
                <span>üîÑ</span> Generate QR Code
            </h3>
            
            <div class="settings-section">
                <h4><span>üìù</span> Content Type</h4>
                <select id="qrTypeSelect" onchange="toggleQrTypeFields()">
                    <option value="text">Text</option>
                    <option value="url">URL</option>
                    <option value="wifi">WiFi</option>
                    <option value="contact">Contact (vCard)</option>
                    <option value="email">Email</option>
                    <option value="sms">SMS</option>
                    <option value="tel">Phone</option>
                    <option value="geo">Location</option>
                    <option value="crypto">Cryptocurrency</option>
                    <option value="event">Event</option>
                </select>
            </div>
            
            <!-- Text/URL Fields -->
            <div id="textFields">
                <label>Enter text or URL</label>
                <textarea id="qrTextInput" placeholder="Enter text or URL here..." rows="3"></textarea>
            </div>
            
            <!-- WiFi Fields -->
            <div id="wifiFields" style="display: none;">
                <label>Network Name (SSID)</label>
                <input type="text" id="wifiSsid" placeholder="Your WiFi name">
                
                <label style="margin-top: 15px;">Password</label>
                <input type="text" id="wifiPassword" placeholder="WiFi password">
                
                <label style="margin-top: 15px;">Security Type</label>
                <select id="wifiSecurity">
                    <option value="WPA">WPA/WPA2</option>
                    <option value="WEP">WEP</option>
                    <option value="nopass">No password</option>
                </select>
            </div>
            
            <!-- Contact Fields -->
            <div id="contactFields" style="display: none;">
                <label>Full Name</label>
                <input type="text" id="contactName" placeholder="John Doe">
                
                <label style="margin-top: 15px;">Phone Number</label>
                <input type="tel" id="contactPhone" placeholder="+1 234 567 8900">
                
                <label style="margin-top: 15px;">Email</label>
                <input type="email" id="contactEmail" placeholder="john@example.com">
                
                <label style="margin-top: 15px;">Company</label>
                <input type="text" id="contactCompany" placeholder="Company Inc.">
            </div>
            
            <!-- Email Fields -->
            <div id="emailFields" style="display: none;">
                <label>Recipient Email</label>
                <input type="email" id="emailTo" placeholder="recipient@example.com">
                
                <label style="margin-top: 15px;">Subject</label>
                <input type="text" id="emailSubject" placeholder="Email subject">
                
                <label style="margin-top: 15px;">Body</label>
                <textarea id="emailBody" placeholder="Email body text..." rows="2"></textarea>
            </div>
            
            <!-- SMS Fields -->
            <div id="smsFields" style="display: none;">
                <label>Phone Number</label>
                <input type="tel" id="smsNumber" placeholder="+1 234 567 8900">
                
                <label style="margin-top: 15px;">Message</label>
                <textarea id="smsMessage" placeholder="Your message..." rows="2"></textarea>
            </div>
            
            <!-- Phone Fields -->
            <div id="phoneFields" style="display: none;">
                <label>Phone Number</label>
                <input type="tel" id="phoneNumber" placeholder="+1 234 567 8900">
            </div>
            
            <!-- Location Fields -->
            <div id="geoFields" style="display: none;">
                <label>Latitude</label>
                <input type="number" id="geoLat" placeholder="40.7128" step="any">
                
                <label style="margin-top: 15px;">Longitude</label>
                <input type="number" id="geoLng" placeholder="-74.0060" step="any">
                
                <label style="margin-top: 15px;">Location Name (Optional)</label>
                <input type="text" id="geoName" placeholder="New York City">
            </div>
            
            <!-- Crypto Fields -->
            <div id="cryptoFields" style="display: none;">
                <label>Cryptocurrency</label>
                <select id="cryptoType">
                    <option value="bitcoin">Bitcoin (BTC)</option>
                    <option value="ethereum">Ethereum (ETH)</option>
                    <option value="litecoin">Litecoin (LTC)</option>
                    <option value="ripple">Ripple (XRP)</option>
                </select>
                
                <label style="margin-top: 15px;">Wallet Address</label>
                <input type="text" id="cryptoAddress" placeholder="1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa">
                
                <label style="margin-top: 15px;">Amount (Optional)</label>
                <input type="number" id="cryptoAmount" placeholder="0.01" step="any">
                
                <label style="margin-top: 15px;">Label (Optional)</label>
                <input type="text" id="cryptoLabel" placeholder="Payment for service">
            </div>
            
            <!-- Event Fields -->
            <div id="eventFields" style="display: none;">
                <label>Event Title</label>
                <input type="text" id="eventTitle" placeholder="Meeting">
                
                <label style="margin-top: 15px;">Start Date & Time</label>
                <input type="datetime-local" id="eventStart">
                
                <label style="margin-top: 15px;">End Date & Time</label>
                <input type="datetime-local" id="eventEnd">
                
                <label style="margin-top: 15px;">Location</label>
                <input type="text" id="eventLocation" placeholder="Conference Room A">
                
                <label style="margin-top: 15px;">Description</label>
                <textarea id="eventDescription" placeholder="Event details..." rows="2"></textarea>
            </div>
            
            <!-- QR Code Display -->
            <div id="qrCodeDisplay" style="display: none;">
                <canvas id="qrCodeCanvas" width="250" height="250"></canvas>
            </div>
            
            <!-- Action Buttons -->
            <div style="display: flex; gap: 10px; margin-top: 25px;">
                <button class="btn btn-generate" onclick="generateQRCode()" style="flex: 2;">
                    <span>üîÑ</span> Generate QR Code
                </button>
                <button class="btn btn-share" onclick="downloadQRCode()" style="flex: 1;" id="downloadBtn" disabled>
                    <span>üíæ</span> Save
                </button>
            </div>
            
            <button class="btn" style="background:transparent; margin-top: 15px;" onclick="toggleGenerateQR()">
                Close
            </button>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div id="toastContainer"></div>
    
    <!-- Footer -->
    <div class="footer">
        <strong>QR Actions Pro - Ultimate QR Code Scanner & Generator</strong>
        <div class="footer-links">
            <a href="#" onclick="showAbout()">About</a>
            <a href="#" onclick="showHelp()">Help</a>
            <a href="#" onclick="toggleSettings()">Settings</a>
            <a href="#" onclick="exportAllData()">Export All</a>
            <a href="#" onclick="showPrivacy()">Privacy</a>
        </div>
        <div style="margin-top: 15px; font-size: 12px; color: #666;">
            Works offline ‚Ä¢ No tracking ‚Ä¢ By Bram Diederik
        </div>
    </div>

    <script>
        // ============ CONSTANTS & CONFIG ============
        const AUTH_KEY = 'qr_actions_pin_v3';
        const HIST_KEY = 'qr_actions_history_v3';
        const CAM_KEY = 'qr_actions_camera_id';
        const LIMIT_KEY = 'qr_actions_limit';
        const SETTINGS_KEY = 'qr_actions_settings_v2';
        const FAVORITES_KEY = 'qr_actions_favorites_v2';
        const BATCH_KEY = 'qr_actions_batch_v2';
        
        let html5QrCode = null;
        let batchHtml5QrCode = null;
        let currentTab = 'scan';
        let currentFilter = 'all';
        let batchMode = false;
        let batchScans = [];
        let settings = {
            continuousScan: false,
            beepOnScan: true,
            saveToCloud: false,
            safeBrowsing: true,
            maskSensitiveData: true,
            defaultUrlAction: 'visit',
            defaultWifiAction: 'show',
            theme: 'dark',
            previewSize: 'medium',
            autoDeleteDays: 30
        };
        
        // ============ SERVICE WORKER (AIRPLANE MODE SUPPORT) ============
        if ('serviceWorker' in navigator) {
            const swCode = `
                const CACHE_NAME = 'qr-actions-pro-v5';
                const ASSETS = [
                    './',
                    'https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js',
                    'https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js'
                ];
                
                self.addEventListener('install', (e) => {
                    e.waitUntil(
                        caches.open(CACHE_NAME).then((cache) => cache.addAll(ASSETS))
                    );
                });
                
                self.addEventListener('fetch', (e) => {
                    e.respondWith(
                        caches.match(e.request).then((res) => res || fetch(e.request))
                    );
                });
                
                self.addEventListener('activate', (e) => {
                    e.waitUntil(
                        caches.keys().then((keys) => 
                            Promise.all(
                                keys.map((key) => {
                                    if (key !== CACHE_NAME) return caches.delete(key);
                                })
                            )
                        )
                    );
                });
            `;
            const blob = new Blob([swCode], { type: 'application/javascript' });
            navigator.serviceWorker.register(URL.createObjectURL(blob));
        }
        
        // ============ QR TYPE DETECTION ============
        function detectQRType(text) {
            const trimmed = text.trim();
            
            // Check for specific patterns
            if (trimmed.startsWith('http://') || trimmed.startsWith('https://')) return 'url';
            if (trimmed.startsWith('WIFI:')) return 'wifi';
            if (trimmed.startsWith('mailto:')) return 'email';
            if (trimmed.startsWith('tel:')) return 'phone';
            if (trimmed.startsWith('sms:')) return 'sms';
            if (trimmed.startsWith('SMSTO:')) return 'sms';
            if (trimmed.startsWith('BEGIN:VCARD')) return 'vcard';
            if (trimmed.startsWith('BEGIN:VEVENT')) return 'event';
            if (trimmed.startsWith('geo:')) return 'geo';
            if (trimmed.startsWith('whatsapp://')) return 'whatsapp';
            if (trimmed.startsWith('twitter://')) return 'twitter';
            if (trimmed.startsWith('instagram://')) return 'instagram';
            if (trimmed.startsWith('facebook://')) return 'facebook';
            if (trimmed.startsWith('bitcoin:') || trimmed.match(/^[13][a-km-zA-HJ-NP-Z1-9]{25,34}$/) || trimmed.startsWith('bc1')) return 'crypto';
            if (trimmed.match(/^0x[a-fA-F0-9]{40}$/)) return 'crypto'; // Ethereum
            if (trimmed.startsWith('ethereum:')) return 'crypto';
            
            // Check for email pattern
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (emailRegex.test(trimmed)) return 'email';
            
            // Check for phone number pattern
            const phoneRegex = /^[\+]?[1-9][\d]{0,15}$/;
            if (phoneRegex.test(trimmed.replace(/[\s\-\(\)]/g, ''))) return 'phone';
            
            // Check for barcode/UPC/EAN
            const barcodeRegex = /^\d{8,13}$/;
            if (barcodeRegex.test(trimmed)) return 'barcode';
            
            // Check for plain coordinates
            const coordRegex = /^-?\d+\.\d+,\s*-?\d+\.\d+$/;
            if (coordRegex.test(trimmed)) return 'geo';
            
            // Check for vCard without BEGIN
            if (trimmed.includes('FN:') && trimmed.includes('TEL:')) return 'vcard';
            
            // Default to text
            return 'text';
        }
        
        // ============ PARSING FUNCTIONS ============
        function parseWifiQR(text) {
            const result = {
                ssid: '',
                password: '',
                security: 'WPA',
                hidden: false
            };
            
            const parts = text.replace('WIFI:', '').split(';');
            parts.forEach(part => {
                if (part.startsWith('S:')) result.ssid = part.substring(2);
                if (part.startsWith('P:')) result.password = part.substring(2);
                if (part.startsWith('T:')) result.security = part.substring(2);
                if (part.startsWith('H:')) result.hidden = part.substring(2) === 'true';
            });
            
            return result;
        }
        
        function parseVCard(text) {
            const lines = text.split('\n');
            const contact = {
                name: '',
                phone: '',
                email: '',
                company: '',
                address: '',
                note: ''
            };
            
            lines.forEach(line => {
                if (line.startsWith('FN:')) contact.name = line.substring(3);
                if (line.startsWith('TEL;')) contact.phone = line.split(':')[1];
                if (line.startsWith('EMAIL;')) contact.email = line.split(':')[1];
                if (line.startsWith('ORG:')) contact.company = line.substring(4);
                if (line.startsWith('ADR;')) contact.address = line.split(':')[1];
                if (line.startsWith('NOTE:')) contact.note = line.substring(5);
            });
            
            return contact;
        }
        
        function parseEmail(text) {
            if (text.startsWith('mailto:')) {
                const parts = text.substring(7).split('?');
                const email = parts[0];
                const params = new URLSearchParams(parts[1] || '');
                return {
                    to: email,
                    subject: params.get('subject') || '',
                    body: params.get('body') || ''
                };
            }
            return { to: text, subject: '', body: '' };
        }
        
        function parseSMS(text) {
            if (text.startsWith('sms:')) {
                const parts = text.substring(4).split('?');
                const number = parts[0];
                const params = new URLSearchParams(parts[1] || '');
                return {
                    number: number,
                    body: params.get('body') || ''
                };
            }
            if (text.startsWith('SMSTO:')) {
                const parts = text.substring(6).split(':');
                return {
                    number: parts[0],
                    body: parts[1] || ''
                };
            }
            return { number: '', body: '' };
        }
        
        function parseGeo(text) {
            if (text.startsWith('geo:')) {
                const coords = text.substring(4).split(',');
                return {
                    lat: coords[0],
                    lng: coords[1],
                    zoom: coords[2] || '15'
                };
            }
            if (text.match(/^-?\d+\.\d+,\s*-?\d+\.\d+$/)) {
                const coords = text.split(',');
                return {
                    lat: coords[0].trim(),
                    lng: coords[1].trim(),
                    zoom: '15'
                };
            }
            return { lat: '', lng: '', zoom: '15' };
        }
        
        function parseCrypto(text) {
            if (text.startsWith('bitcoin:')) {
                const parts = text.substring(8).split('?');
                const address = parts[0];
                const params = new URLSearchParams(parts[1] || '');
                return {
                    type: 'bitcoin',
                    address: address,
                    amount: params.get('amount') || '',
                    label: params.get('label') || '',
                    message: params.get('message') || ''
                };
            }
            if (text.startsWith('ethereum:')) {
                return {
                    type: 'ethereum',
                    address: text.substring(9)
                };
            }
            // Check if it's a raw address
            if (text.match(/^[13][a-km-zA-HJ-NP-Z1-9]{25,34}$/)) {
                return { type: 'bitcoin', address: text };
            }
            if (text.match(/^0x[a-fA-F0-9]{40}$/)) {
                return { type: 'ethereum', address: text };
            }
            return { type: 'unknown', address: text };
        }
        
        // ============ HELPER FUNCTIONS ============
        function showToast(message, type = 'success', duration = 3000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span>${type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : '‚ö†'}</span>
                ${message}
            `;
            container.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 400);
            }, duration);
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Copied to clipboard!', 'success');
            }).catch(err => {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showToast('Copied to clipboard!', 'success');
            });
        }
        
        function vibrate(pattern = [100]) {
            if (navigator.vibrate) navigator.vibrate(pattern);
        }
        
        // ============ CAMERA MANAGEMENT ============
        async function getCameras() {
            try {
                const devices = await Html5Qrcode.getCameras();
                const select = document.getElementById('cameraSelect');
                if (devices && devices.length > 0) {
                    select.innerHTML = '';
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.text = 'Default (Environment)';
                    select.appendChild(defaultOption);
                    
                    devices.forEach(device => {
                        const option = document.createElement('option');
                        option.value = device.id;
                        option.text = device.label || `Camera ${select.length}`;
                        if(localStorage.getItem(CAM_KEY) === device.id) option.selected = true;
                        select.appendChild(option);
                    });
                }
            } catch (e) {
                console.error('Camera error:', e);
            }
        }
        
        // ============ SETTINGS MANAGEMENT ============
        function loadSettings() {
            try {
                const saved = JSON.parse(localStorage.getItem(SETTINGS_KEY) || '{}');
                settings = { ...settings, ...saved };
                
                // Apply theme
                if (settings.theme === 'light') {
                    document.documentElement.style.setProperty('--bg', '#f8f9fa');
                    document.documentElement.style.setProperty('--card', '#ffffff');
                    document.documentElement.style.setProperty('--dark-grey', '#e9ecef');
                } else if (settings.theme === 'auto') {
                    // Auto theme detection
                    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    if (prefersDark) {
                        document.documentElement.style.setProperty('--bg', '#121212');
                        document.documentElement.style.setProperty('--card', '#1e1e1e');
                    } else {
                        document.documentElement.style.setProperty('--bg', '#f8f9fa');
                        document.documentElement.style.setProperty('--card', '#ffffff');
                    }
                }
            } catch (e) {
                console.error('Error loading settings:', e);
            }
        }
        
        function toggleSettings() {
            const overlay = document.getElementById('settingsOverlay');
            if (overlay.style.display === 'flex') {
                overlay.style.display = 'none';
            } else {
                overlay.style.display = 'flex';
                loadSettingsIntoForm();
                getCameras();
            }
        }
        
        function loadSettingsIntoForm() {
            document.getElementById('pinInput').value = localStorage.getItem(AUTH_KEY) || '';
            document.getElementById('limitInput').value = localStorage.getItem(LIMIT_KEY) || '50';
            document.getElementById('autoDeleteInput').value = settings.autoDeleteDays || '30';
            document.getElementById('continuousScan').checked = settings.continuousScan || false;
            document.getElementById('beepOnScan').checked = settings.beepOnScan !== false;
            document.getElementById('saveToCloud').checked = settings.saveToCloud || false;
            document.getElementById('safeBrowsingCheck').checked = settings.safeBrowsing !== false;
            document.getElementById('maskSensitiveData').checked = settings.maskSensitiveData !== false;
            document.getElementById('themeSelect').value = settings.theme || 'dark';
            document.getElementById('previewSize').value = settings.previewSize || 'medium';
            document.getElementById('defaultUrlAction').value = settings.defaultUrlAction || 'visit';
            document.getElementById('defaultWifiAction').value = settings.defaultWifiAction || 'show';
        }
        
        function saveSettings() {
            localStorage.setItem(AUTH_KEY, document.getElementById('pinInput').value);
            localStorage.setItem(LIMIT_KEY, document.getElementById('limitInput').value);
            
            settings.continuousScan = document.getElementById('continuousScan').checked;
            settings.beepOnScan = document.getElementById('beepOnScan').checked;
            settings.saveToCloud = document.getElementById('saveToCloud').checked;
            settings.safeBrowsing = document.getElementById('safeBrowsingCheck').checked;
            settings.maskSensitiveData = document.getElementById('maskSensitiveData').checked;
            settings.theme = document.getElementById('themeSelect').value;
            settings.previewSize = document.getElementById('previewSize').value;
            settings.defaultUrlAction = document.getElementById('defaultUrlAction').value;
            settings.defaultWifiAction = document.getElementById('defaultWifiAction').value;
            settings.autoDeleteDays = parseInt(document.getElementById('autoDeleteInput').value) || 30;
            
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
            localStorage.setItem(CAM_KEY, document.getElementById('cameraSelect').value);
            
            loadSettings(); // Reload to apply theme
            toggleSettings();
            showToast('Settings saved!', 'success');
        }
        
        function clearAllData() {
            if (confirm("‚ö†Ô∏è This will permanently delete ALL settings, history, and favorites. Are you sure?")) {
                if (confirm("‚ùå Final confirmation: This cannot be undone!")) {
                    localStorage.clear();
                    showToast('All data cleared!', 'warning');
                    setTimeout(() => location.reload(), 1500);
                }
            }
        }
        
        // ============ SCANNING FUNCTIONS ============
        async function startScan() {
            const actions = document.getElementById('mainActions');
            const abortBtn = document.getElementById('abortBtn');
            
            if (html5QrCode) {
                await stopScan();
                return;
            }
            
            html5QrCode = new Html5Qrcode("reader");
            const cameraId = localStorage.getItem(CAM_KEY);
            const config = cameraId ? { deviceId: { exact: cameraId } } : { facingMode: "environment" };
            
            try {
                await html5QrCode.start(
                    config,
                    { fps: 20, qrbox: { width: 250, height: 250 } },
                    (text) => {
                        if (!settings.continuousScan) {
                            stopScan();
                        }
                        vibrate([100, 50, 100]);
                        if (settings.beepOnScan) {
                            // Create beep sound
                            try {
                                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                                const oscillator = audioContext.createOscillator();
                                const gainNode = audioContext.createGain();
                                oscillator.connect(gainNode);
                                gainNode.connect(audioContext.destination);
                                oscillator.frequency.value = 800;
                                oscillator.type = 'sine';
                                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                                oscillator.start(audioContext.currentTime);
                                oscillator.stop(audioContext.currentTime + 0.1);
                            } catch (e) {
                                console.log('Audio not supported');
                            }
                        }
                        saveScan(text);
                    },
                    () => {
                        // Quiet error handler
                    }
                ).then(() => {
                    actions.style.display = 'none';
                    abortBtn.style.display = 'block';
                });
            } catch (err) {
                console.error('Camera error:', err);
                showToast('Camera access denied or not available', 'error');
                html5QrCode = null;
            }
        }
        
        async function stopScan() {
            if (html5QrCode) {
                try {
                    await html5QrCode.stop();
                } catch (e) {
                    // Ignore stop errors
                }
                html5QrCode = null;
            }
            document.getElementById('mainActions').style.display = 'flex';
            document.getElementById('abortBtn').style.display = 'none';
        }
        
        function uploadImage(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const html5QrCodeFile = new Html5Qrcode("reader");
            html5QrCodeFile.scanFile(file, true)
                .then(qrCodeMessage => {
                    vibrate([100]);
                    saveScan(qrCodeMessage);
                    showToast('QR code found!', 'success');
                    event.target.value = "";
                })
                .catch(err => {
                    showToast('No QR code found in image', 'error');
                    event.target.value = "";
                });
        }
        
        // ============ BATCH SCAN FUNCTIONS ============
        function startBatchMode() {
            batchMode = true;
            batchScans = [];
            document.getElementById('batchCounter').style.display = 'block';
            document.getElementById('batchScanned').textContent = '0';
            document.getElementById('batchResults').innerHTML = '';
            
            // Start scanning
            batchHtml5QrCode = new Html5Qrcode("batchReader");
            const cameraId = localStorage.getItem(CAM_KEY);
            const config = cameraId ? { deviceId: { exact: cameraId } } : { facingMode: "environment" };
            
            batchHtml5QrCode.start(
                config,
                { fps: 10, qrbox: { width: 250, height: 250 } },
                (text) => {
                    vibrate([50]);
                    batchScans.push({
                        text: text,
                        date: new Date().toLocaleString(),
                        id: Date.now() + Math.random()
                    });
                    document.getElementById('batchScanned').textContent = batchScans.length;
                    updateBatchResults();
                    
                    // Show quick preview
                    showToast(`Scanned: ${text.substring(0, 30)}${text.length > 30 ? '...' : ''}`, 'info', 1000);
                }
            ).then(() => {
                document.querySelector('#batchTab .btn-scan').style.display = 'none';
                document.querySelector('#batchTab .btn-abort').style.display = 'block';
                document.querySelector('#batchTab .btn-share').style.display = 'block';
            });
        }
        
        function stopBatchMode() {
            if (batchHtml5QrCode) {
                batchHtml5QrCode.stop().then(() => {
                    batchHtml5QrCode = null;
                    batchMode = false;
                    document.querySelector('#batchTab .btn-scan').style.display = 'block';
                    document.querySelector('#batchTab .btn-abort').style.display = 'none';
                    showToast(`Batch scan completed: ${batchScans.length} items`, 'success');
                });
            }
        }
        
        function updateBatchResults() {
            const container = document.getElementById('batchResults');
            container.innerHTML = batchScans.map((scan, idx) => `
                <div class="qr-card" style="animation-delay: ${idx * 0.05}s;">
                    <div class="qr-date">${scan.date}</div>
                    <code>${scan.text.substring(0, 100)}${scan.text.length > 100 ? '...' : ''}</code>
                    <button class="btn btn-small btn-copy" onclick="copyToClipboard('${scan.text.replace(/'/g, "\\'")}')" style="margin-top:10px;">
                        üìã Copy
                    </button>
                </div>
            `).join('');
        }
        
        function exportBatchData() {
            if (batchScans.length === 0) {
                showToast('No batch data to export', 'warning');
                return;
            }
            
            const data = batchScans.map(scan => `${scan.date}\t${scan.text}`).join('\n');
            const blob = new Blob([data], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `qr_batch_${new Date().toISOString().slice(0,10)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            showToast(`Exported ${batchScans.length} items`, 'success');
        }
        
        // ============ SCAN HISTORY MANAGEMENT ============
        function saveScan(text) {
            let history = JSON.parse(localStorage.getItem(HIST_KEY) || "[]");
            const newItem = {
                text: text,
                date: new Date().toLocaleString(),
                id: Date.now(),
                type: detectQRType(text),
                favorite: false,
                parsed: parseQRContent(text)
            };
            
            history.unshift(newItem);
            
            // Apply limit
            const limit = parseInt(localStorage.getItem(LIMIT_KEY) || "50");
            if (limit > 0) {
                history = history.slice(0, limit);
            }
            
            localStorage.setItem(HIST_KEY, JSON.stringify(history));
            render();
            updateStats();
            
            // Auto-perform default actions
            performDefaultAction(newItem);
        }
        
        function parseQRContent(text) {
            const type = detectQRType(text);
            switch(type) {
                case 'wifi': return parseWifiQR(text);
                case 'vcard': return parseVCard(text);
                case 'email': return parseEmail(text);
                case 'sms': return parseSMS(text);
                case 'geo': return parseGeo(text);
                case 'crypto': return parseCrypto(text);
                default: return { raw: text };
            }
        }
        
        function performDefaultAction(item) {
            switch(item.type) {
                case 'url':
                    if (settings.defaultUrlAction === 'visit') {
                        setTimeout(() => window.open(item.text, '_blank'), 500);
                    } else if (settings.defaultUrlAction === 'safety') {
                        checkSafety(item.text);
                    }
                    break;
                case 'wifi':
                    if (settings.defaultWifiAction === 'copy') {
                        const wifi = parseWifiQR(item.text);
                        copyToClipboard(wifi.password);
                    }
                    break;
            }
        }
        
        function toggleFavorite(id) {
            let history = JSON.parse(localStorage.getItem(HIST_KEY) || "[]");
            const itemIndex = history.findIndex(item => item.id === id);
            if (itemIndex !== -1) {
                history[itemIndex].favorite = !history[itemIndex].favorite;
                localStorage.setItem(HIST_KEY, JSON.stringify(history));
                localStorage.setItem(FAVORITES_KEY, JSON.stringify(
                    history.filter(item => item.favorite)
                ));
                render();
                updateStats();
                showToast(history[itemIndex].favorite ? 'Added to favorites!' : 'Removed from favorites', 'success');
            }
        }
        
        function deleteItem(id) {
            let history = JSON.parse(localStorage.getItem(HIST_KEY) || "[]");
            history = history.filter(item => item.id !== id);
            localStorage.setItem(HIST_KEY, JSON.stringify(history));
            render();
            updateStats();
            showToast('Item deleted', 'warning');
        }
        
        function clearOldScans() {
            const days = settings.autoDeleteDays;
            if (days <= 0) return;
            
            let history = JSON.parse(localStorage.getItem(HIST_KEY) || "[]");
            const cutoff = new Date();
            cutoff.setDate(cutoff.getDate() - days);
            
            const oldCount = history.length;
            history = history.filter(item => {
                const itemDate = new Date(item.id);
                return itemDate > cutoff;
            });
            
            if (history.length < oldCount) {
                localStorage.setItem(HIST_KEY, JSON.stringify(history));
                render();
                updateStats();
                showToast(`Cleaned ${oldCount - history.length} old scans`, 'success');
            } else {
                showToast('No old scans to clean', 'info');
            }
        }
        
        // ============ RENDERING FUNCTIONS ============
        function getTypeBadge(type) {
            const badges = {
                'url': { text: 'URL', icon: 'üåê', class: 'badge-url' },
                'wifi': { text: 'WiFi', icon: 'üì∂', class: 'badge-wifi' },
                'text': { text: 'Text', icon: 'üìù', class: 'badge-text' },
                'email': { text: 'Email', icon: 'üìß', class: 'badge-email' },
                'phone': { text: 'Phone', icon: 'üìû', class: 'badge-tel' },
                'sms': { text: 'SMS', icon: 'üí¨', class: 'badge-sms' },
                'vcard': { text: 'Contact', icon: 'üë§', class: 'badge-vcard' },
                'geo': { text: 'Location', icon: 'üìç', class: 'badge-geo' },
                'crypto': { text: 'Crypto', icon: '‚Çø', class: 'badge-crypto' },
                'event': { text: 'Event', icon: 'üìÖ', class: 'badge-calendar' },
                'whatsapp': { text: 'WhatsApp', icon: 'üíö', class: 'badge-whatsapp' },
                'barcode': { text: 'Barcode', icon: 'üìä', class: 'badge-barcode' }
            };
            
            return badges[type] || badges['text'];
        }
        
        function renderQRContent(item) {
            const type = item.type || detectQRType(item.text);
            const badge = getTypeBadge(type);
            
            let contentHtml = '';
            
            switch(type) {
                case 'url':
                    contentHtml = `
                        <div class="qr-preview">
                            <strong>URL:</strong><br>
                            <a href="${item.text}" target="_blank" style="color: var(--accent); word-break: break-all;">
                                ${item.text}
                            </a>
                        </div>
                    `;
                    break;
                    
                case 'wifi':
                    const wifi = parseWifiQR(item.text);
                    contentHtml = `
                        <div class="qr-preview">
                            <strong>WiFi Network:</strong><br>
                            <div style="margin-top: 10px;">
                                <strong>SSID:</strong> ${wifi.ssid || 'Unknown'}<br>
                                <strong>Security:</strong> ${wifi.security}<br>
                                <strong>Password:</strong> 
                                <span id="wifi_${item.id}" class="wifi-pass ${settings.maskSensitiveData ? '' : 'show'}" 
                                      onclick="togglePass('wifi_${item.id}')">
                                    ${wifi.password || 'No password'}
                                </span>
                                ${wifi.hidden ? '<br><strong>Hidden network</strong>' : ''}
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'vcard':
                    const contact = parseVCard(item.text);
                    contentHtml = `
                        <div class="contact-info">
                            <div class="contact-field">
                                <span>üë§</span>
                                <strong>${contact.name || 'Unnamed Contact'}</strong>
                            </div>
                            ${contact.phone ? `
                            <div class="contact-field">
                                <span>üìû</span>
                                ${contact.phone}
                            </div>` : ''}
                            ${contact.email ? `
                            <div class="contact-field">
                                <span>üìß</span>
                                ${contact.email}
                            </div>` : ''}
                            ${contact.company ? `
                            <div class="contact-field">
                                <span>üè¢</span>
                                ${contact.company}
                            </div>` : ''}
                            ${contact.address ? `
                            <div class="contact-field">
                                <span>üìç</span>
                                ${contact.address}
                            </div>` : ''}
                        </div>
                    `;
                    break;
                    
                case 'email':
                    const email = parseEmail(item.text);
                    contentHtml = `
                        <div class="qr-preview">
                            <strong>Email:</strong><br>
                            <div style="margin-top: 10px;">
                                <strong>To:</strong> ${email.to}<br>
                                ${email.subject ? `<strong>Subject:</strong> ${email.subject}<br>` : ''}
                                ${email.body ? `<strong>Body:</strong> ${email.body.substring(0, 100)}${email.body.length > 100 ? '...' : ''}` : ''}
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'sms':
                    const sms = parseSMS(item.text);
                    contentHtml = `
                        <div class="qr-preview">
                            <strong>SMS:</strong><br>
                            <div style="margin-top: 10px;">
                                ${sms.number ? `<strong>To:</strong> ${sms.number}<br>` : ''}
                                ${sms.body ? `<strong>Message:</strong> ${sms.body.substring(0, 100)}${sms.body.length > 100 ? '...' : ''}` : ''}
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'geo':
                    const geo = parseGeo(item.text);
                    contentHtml = `
                        <div class="qr-preview">
                            <strong>Location:</strong><br>
                            <div style="margin-top: 10px;">
                                <strong>Latitude:</strong> ${geo.lat}<br>
                                <strong>Longitude:</strong> ${geo.lng}<br>
                                <button class="btn btn-small btn-maps" onclick="openMaps('${geo.lat}', '${geo.lng}')" style="margin-top:8px;">
                                    üìç Open in Maps
                                </button>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'crypto':
                    const crypto = parseCrypto(item.text);
                    contentHtml = `
                        <div class="qr-preview">
                            <strong>Cryptocurrency:</strong><br>
                            <div style="margin-top: 10px;">
                                <strong>Type:</strong> ${crypto.type.toUpperCase()}<br>
                                <strong>Address:</strong> <code style="font-size:12px;">${crypto.address}</code><br>
                                ${crypto.amount ? `<strong>Amount:</strong> ${crypto.amount}<br>` : ''}
                                ${crypto.label ? `<strong>Label:</strong> ${crypto.label}` : ''}
                            </div>
                        </div>
                    `;
                    break;
                    
                default:
                    contentHtml = `
                        <div class="qr-preview">
                            <code>${item.text}</code>
                        </div>
                    `;
            }
            
            return { badge, contentHtml };
        }
        
        function getTypeActions(item) {
            const type = item.type || detectQRType(item.text);
            let actions = [];
            
            // Common actions for all types
            actions.push({
                text: 'üìã Copy',
                class: 'btn-copy',
                onclick: `copyToClipboard('${item.text.replace(/'/g, "\\'")}')`
            });
            
            actions.push({
                text: item.favorite ? '‚≠ê Saved' : '‚≠ê Favorite',
                class: 'btn-favorite',
                onclick: `toggleFavorite(${item.id})`
            });
            
            // Type-specific actions
            switch(type) {
                case 'url':
                    actions.push({
                        text: 'üåê Visit',
                        class: 'btn-share',
                        onclick: `window.open('${item.text}', '_blank')`
                    });
                    actions.push({
                        text: 'üõ° Safety',
                        class: 'btn-sec',
                        onclick: `checkSafety('${item.text}')`
                    });
                    break;
                    
                case 'wifi':
                    const wifi = parseWifiQR(item.text);
                    actions.push({
                        text: 'üì∂ Copy WiFi',
                        class: 'btn-share',
                        onclick: `copyToClipboard('WIFI:S:${wifi.ssid};T:${wifi.security};P:${wifi.password};;')`
                    });
                    actions.push({
                        text: 'üîë Copy Pass',
                        class: 'btn-copy',
                        onclick: `copyToClipboard('${wifi.password}')`
                    });
                    break;
                    
                case 'email':
                    const email = parseEmail(item.text);
                    actions.push({
                        text: 'üìß Send',
                        class: 'btn-email',
                        onclick: `window.open('mailto:${email.to}?subject=${encodeURIComponent(email.subject)}&body=${encodeURIComponent(email.body)}')`
                    });
                    break;
                    
                case 'phone':
                    actions.push({
                        text: 'üìû Call',
                        class: 'btn-phone',
                        onclick: `window.open('tel:${item.text.replace('tel:', '')}')`
                    });
                    break;
                    
                case 'sms':
                    const sms = parseSMS(item.text);
                    actions.push({
                        text: 'üí¨ SMS',
                        class: 'btn-sms',
                        onclick: `window.open('sms:${sms.number}?body=${encodeURIComponent(sms.body)}')`
                    });
                    break;
                    
                case 'vcard':
                    actions.push({
                        text: 'üë§ Save Contact',
                        class: 'btn-share',
                        onclick: `saveContact('${item.text.replace(/'/g, "\\'")}')`
                    });
                    break;
                    
                case 'crypto':
                    actions.push({
                        text: '‚Çø Copy Address',
                        class: 'btn-crypto',
                        onclick: `copyToClipboard('${item.text}')`
                    });
                    break;
                    
                case 'geo':
                    const geo = parseGeo(item.text);
                    actions.push({
                        text: 'üìç Maps',
                        class: 'btn-maps',
                        onclick: `openMaps('${geo.lat}', '${geo.lng}')`
                    });
                    break;
                    
                case 'whatsapp':
                    actions.push({
                        text: 'üíö WhatsApp',
                        class: 'btn-share',
                        onclick: `window.open('${item.text}', '_blank')`
                    });
                    break;
            }
            
            // Add share action
            actions.push({
                text: 'üì§ Share',
                class: 'btn-share',
                onclick: `shareData('${item.text.replace(/'/g, "\\'")}')`
            });
            
            return actions;
        }
        
        function render() {
            const container = document.getElementById('history');
            let items = JSON.parse(localStorage.getItem(HIST_KEY) || "[]");
            
            // Apply filter
            if (currentFilter !== 'all') {
                if (currentFilter === 'favorites') {
                    items = items.filter(item => item.favorite);
                } else {
                    items = items.filter(item => item.type === currentFilter || detectQRType(item.text) === currentFilter);
                }
            }
            
            // Apply search
            const searchTerm = document.getElementById('searchInput')?.value.toLowerCase();
            if (searchTerm) {
                items = items.filter(item => 
                    item.text.toLowerCase().includes(searchTerm) ||
                    item.date.toLowerCase().includes(searchTerm)
                );
            }
            
            if (items.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üì≠</div>
                        <h3 style="color:#888;">No scans found</h3>
                        <p class="empty-text">${searchTerm ? 'Try a different search term' : 'Start by scanning a QR code!'}</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = items.map((item, idx) => {
                const { badge, contentHtml } = renderQRContent(item);
                const actions = getTypeActions(item);
                
                return `
                    <div class="qr-card" style="animation: slideIn 0.3s ease ${idx * 0.05}s both;">
                        <button class="delete-btn" onclick="deleteItem(${item.id})" title="Delete">
                            ‚úï
                        </button>
                        
                        <div class="qr-card-header">
                            <span class="qr-type-badge ${badge.class}">
                                <span>${badge.icon}</span>
                                ${badge.text}
                            </span>
                            <button class="favorite-btn ${item.favorite ? 'active' : ''}" onclick="toggleFavorite(${item.id})" title="${item.favorite ? 'Remove from favorites' : 'Add to favorites'}">
                                ${item.favorite ? '‚≠ê' : '‚òÜ'}
                            </button>
                        </div>
                        
                        <div class="qr-date">
                            <span>üìÖ</span> ${item.date}
                        </div>
                        
                        <div class="qr-content">
                            ${contentHtml}
                        </div>
                        
                        <div class="qr-actions">
                            ${actions.map(action => `
                                <button class="btn btn-small ${action.class}" onclick="${action.onclick}">
                                    ${action.text}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderFavorites() {
            const container = document.getElementById('favorites');
            const items = JSON.parse(localStorage.getItem(HIST_KEY) || "[]").filter(item => item.favorite);
            
            const searchTerm = document.getElementById('favoritesSearch')?.value.toLowerCase();
            let filteredItems = items;
            if (searchTerm) {
                filteredItems = items.filter(item => 
                    item.text.toLowerCase().includes(searchTerm) ||
                    item.date.toLowerCase().includes(searchTerm)
                );
            }
            
            if (filteredItems.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚≠ê</div>
                        <h3 style="color:#888;">No favorites yet</h3>
                        <p class="empty-text">Tap the star icon on any scan to add it here</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredItems.map((item, idx) => {
                const { badge, contentHtml } = renderQRContent(item);
                const actions = getTypeActions(item);
                
                return `
                    <div class="qr-card" style="animation: slideIn 0.3s ease ${idx * 0.05}s both; border-color: var(--yellow);">
                        <button class="delete-btn" onclick="deleteItem(${item.id})" title="Delete">
                            ‚úï
                        </button>
                        
                        <div class="qr-card-header">
                            <span class="qr-type-badge ${badge.class}">
                                <span>${badge.icon}</span>
                                ${badge.text}
                            </span>
                            <button class="favorite-btn active" onclick="toggleFavorite(${item.id})" title="Remove from favorites">
                                ‚≠ê
                            </button>
                        </div>
                        
                        <div class="qr-date">
                            <span>üìÖ</span> ${item.date}
                        </div>
                        
                        <div class="qr-content">
                            ${contentHtml}
                        </div>
                        
                        <div class="qr-actions">
                            ${actions.slice(0, 4).map(action => `
                                <button class="btn btn-small ${action.class}" onclick="${action.onclick}">
                                    ${action.text}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ============ UI FUNCTIONS ============
        function switchTab(tabName) {
            currentTab = tabName;
            
            // Hide all tabs
            document.getElementById('scanTab').style.display = 'none';
            document.getElementById('historyTab').style.display = 'none';
            document.getElementById('favoritesTab').style.display = 'none';
            document.getElementById('batchTab').style.display = 'none';
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab and activate button
            document.getElementById(`${tabName}Tab`).style.display = 'block';
            document.querySelectorAll('.tab-btn').forEach(btn => {
                if (btn.textContent.includes(tabName.charAt(0).toUpperCase() + tabName.slice(1))) {
                    btn.classList.add('active');
                }
            });
            
            // Render appropriate content
            if (tabName === 'history') {
                render();
            } else if (tabName === 'favorites') {
                renderFavorites();
            } else if (tabName === 'batch') {
                updateBatchDisplay();
            }
            
            // Stop any active scan
            if (tabName !== 'scan' && html5QrCode) {
                stopScan();
            }
        }
        
        function setFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-tab').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            render();
        }
        
        function filterHistory() {
            render();
        }
        
        function filterFavorites() {
            renderFavorites();
        }
        
        function togglePass(id) {
            const element = document.getElementById(id);
            if (element) {
                element.classList.toggle('show');
            }
        }
        
        function updateStats() {
            const history = JSON.parse(localStorage.getItem(HIST_KEY) || "[]");
            const favorites = history.filter(item => item.favorite).length;
            const total = history.length;
            
            document.getElementById('statsBadge').textContent = total;
            document.getElementById('historyCount').textContent = total;
            document.getElementById('favoritesCount').textContent = favorites;
            document.getElementById('batchCount').textContent = batchScans.length;
        }
        
        function updateBatchDisplay() {
            // Update batch display if needed
        }
        
        // ============ ACTION FUNCTIONS ============
        function checkSafety(urlToTest) {
            const encodedUrl = btoa(urlToTest.trim()).replace(/=/g, "");
            window.open(`https://www.virustotal.com/gui/url/${encodedUrl}/detection`, '_blank');
        }
        
        function openMaps(lat, lng) {
            window.open(`https://www.google.com/maps/search/?api=1&query=${lat},${lng}`, '_blank');
        }
        
        function saveContact(vcardData) {
            const blob = new Blob([vcardData], { type: 'text/vcard' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'contact.vcf';
            a.click();
            URL.revokeObjectURL(url);
            showToast('Contact saved as vCard file', 'success');
        }
        
        async function shareData(text) {
            const pin = localStorage.getItem(AUTH_KEY);
            const payload = text + (pin ? `\nPIN: ${pin}` : '');
            
            if (navigator.share) {
                try {
                    const file = new File([payload], `qr_${Date.now()}.txt`, { type: 'text/plain' });
                    await navigator.share({ files: [file], title: 'QR Data' });
                    showToast('Shared successfully!', 'success');
                } catch (e) {
                    if (e.name !== 'AbortError') {
                        copyToClipboard(payload);
                    }
                }
            } else {
                copyToClipboard(payload);
            }
        }
        
        function copyAllHistory() {
            const history = JSON.parse(localStorage.getItem(HIST_KEY) || "[]");
            const text = history.map(item => `[${item.date}] ${item.text}`).join('\n\n');
            if (text) {
                copyToClipboard(text);
            } else {
                showToast('No history to copy', 'warning');
            }
        }
        
        function exportHistory() {
            const history = JSON.parse(localStorage.getItem(HIST_KEY) || "[]");
            const csv = history.map(item => `"${item.date}","${item.text.replace(/"/g, '""')}"`).join('\n');
            const blob = new Blob(['Date,Content\n' + csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `qr_history_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            showToast(`Exported ${history.length} items`, 'success');
        }
        
        function exportAllData() {
            const history = JSON.parse(localStorage.getItem(HIST_KEY) || "[]");
            const data = {
                version: '2.0',
                exportDate: new Date().toISOString(),
                history: history,
                settings: settings,
                favorites: history.filter(item => item.favorite).map(item => item.id)
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `qr_actions_backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Backup exported!', 'success');
        }
        
        // ============ QR GENERATION FUNCTIONS ============
        function toggleGenerateQR() {
            const overlay = document.getElementById('generateOverlay');
            if (overlay.style.display === 'flex') {
                overlay.style.display = 'none';
                document.getElementById('qrCodeDisplay').style.display = 'none';
                document.getElementById('downloadBtn').disabled = true;
            } else {
                overlay.style.display = 'flex';
                // Set current time for event fields
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                document.getElementById('eventStart').value = `${year}-${month}-${day}T${hours}:${minutes}`;
                document.getElementById('eventEnd').value = `${year}-${month}-${day}T${String(now.getHours() + 1).padStart(2, '0')}:${minutes}`;
            }
        }
        
        function toggleQrTypeFields() {
            const type = document.getElementById('qrTypeSelect').value;
            
            // Hide all fields
            document.getElementById('textFields').style.display = 'none';
            document.getElementById('wifiFields').style.display = 'none';
            document.getElementById('contactFields').style.display = 'none';
            document.getElementById('emailFields').style.display = 'none';
            document.getElementById('smsFields').style.display = 'none';
            document.getElementById('phoneFields').style.display = 'none';
            document.getElementById('geoFields').style.display = 'none';
            document.getElementById('cryptoFields').style.display = 'none';
            document.getElementById('eventFields').style.display = 'none';
            
            // Show selected fields
            switch(type) {
                case 'text':
                case 'url':
                    document.getElementById('textFields').style.display = 'block';
                    break;
                case 'wifi':
                    document.getElementById('wifiFields').style.display = 'block';
                    break;
                case 'contact':
                    document.getElementById('contactFields').style.display = 'block';
                    break;
                case 'email':
                    document.getElementById('emailFields').style.display = 'block';
                    break;
                case 'sms':
                    document.getElementById('smsFields').style.display = 'block';
                    break;
                case 'tel':
                    document.getElementById('phoneFields').style.display = 'block';
                    break;
                case 'geo':
                    document.getElementById('geoFields').style.display = 'block';
                    break;
                case 'crypto':
                    document.getElementById('cryptoFields').style.display = 'block';
                    break;
                case 'event':
                    document.getElementById('eventFields').style.display = 'block';
                    break;
            }
        }
        
        function generateQRCode() {
            const type = document.getElementById('qrTypeSelect').value;
            let qrText = '';
            
            switch(type) {
                case 'text':
                case 'url':
                    qrText = document.getElementById('qrTextInput').value;
                    if (!qrText) {
                        showToast('Please enter text or URL', 'error');
                        return;
                    }
                    break;
                    
                case 'wifi':
                    const ssid = document.getElementById('wifiSsid').value;
                    const password = document.getElementById('wifiPassword').value;
                    const security = document.getElementById('wifiSecurity').value;
                    if (!ssid) {
                        showToast('Please enter WiFi name', 'error');
                        return;
                    }
                    qrText = `WIFI:S:${ssid};T:${security};P:${password};;`;
                    break;
                    
                case 'contact':
                    const name = document.getElementById('contactName').value;
                    const phone = document.getElementById('contactPhone').value;
                    const email = document.getElementById('contactEmail').value;
                    const company = document.getElementById('contactCompany').value;
                    
                    if (!name) {
                        showToast('Please enter contact name', 'error');
                        return;
                    }
                    
                    qrText = `BEGIN:VCARD\nVERSION:3.0\nFN:${name}`;
                    if (phone) qrText += `\nTEL:${phone}`;
                    if (email) qrText += `\nEMAIL:${email}`;
                    if (company) qrText += `\nORG:${company}`;
                    qrText += `\nEND:VCARD`;
                    break;
                    
                case 'email':
                    const emailTo = document.getElementById('emailTo').value;
                    const subject = document.getElementById('emailSubject').value;
                    const body = document.getElementById('emailBody').value;
                    
                    if (!emailTo) {
                        showToast('Please enter recipient email', 'error');
                        return;
                    }
                    
                    qrText = `mailto:${emailTo}`;
                    const params = [];
                    if (subject) params.push(`subject=${encodeURIComponent(subject)}`);
                    if (body) params.push(`body=${encodeURIComponent(body)}`);
                    if (params.length > 0) qrText += `?${params.join('&')}`;
                    break;
                    
                case 'sms':
                    const smsNumber = document.getElementById('smsNumber').value;
                    const smsMessage = document.getElementById('smsMessage').value;
                    
                    if (!smsNumber) {
                        showToast('Please enter phone number', 'error');
                        return;
                    }
                    
                    qrText = `sms:${smsNumber}`;
                    if (smsMessage) qrText += `?body=${encodeURIComponent(smsMessage)}`;
                    break;
                    
                case 'tel':
                    const phoneNumber = document.getElementById('phoneNumber').value;
                    if (!phoneNumber) {
                        showToast('Please enter phone number', 'error');
                        return;
                    }
                    qrText = `tel:${phoneNumber}`;
                    break;
                    
                case 'geo':
                    const lat = document.getElementById('geoLat').value;
                    const lng = document.getElementById('geoLng').value;
                    const geoName = document.getElementById('geoName').value;
                    
                    if (!lat || !lng) {
                        showToast('Please enter coordinates', 'error');
                        return;
                    }
                    
                    qrText = `geo:${lat},${lng}`;
                    if (geoName) qrText += `?q=${encodeURIComponent(geoName)}`;
                    break;
                    
                case 'crypto':
                    const cryptoType = document.getElementById('cryptoType').value;
                    const address = document.getElementById('cryptoAddress').value;
                    const amount = document.getElementById('cryptoAmount').value;
                    const label = document.getElementById('cryptoLabel').value;
                    
                    if (!address) {
                        showToast('Please enter wallet address', 'error');
                        return;
                    }
                    
                    if (cryptoType === 'bitcoin') {
                        qrText = `bitcoin:${address}`;
                        const params = [];
                        if (amount) params.push(`amount=${amount}`);
                        if (label) params.push(`label=${encodeURIComponent(label)}`);
                        if (params.length > 0) qrText += `?${params.join('&')}`;
                    } else {
                        qrText = `${cryptoType}:${address}`;
                    }
                    break;
                    
                case 'event':
                    const eventTitle = document.getElementById('eventTitle').value;
                    const eventStart = document.getElementById('eventStart').value;
                    const eventEnd = document.getElementById('eventEnd').value;
                    const eventLocation = document.getElementById('eventLocation').value;
                    const eventDescription = document.getElementById('eventDescription').value;
                    
                    if (!eventTitle) {
                        showToast('Please enter event title', 'error');
                        return;
                    }
                    
                    const startDate = new Date(eventStart);
                    const endDate = new Date(eventEnd);
                    
                    qrText = `BEGIN:VEVENT\nSUMMARY:${eventTitle}\nDTSTART:${startDate.toISOString().replace(/[-:]/g, '').split('.')[0]}Z\nDTEND:${endDate.toISOString().replace(/[-:]/g, '').split('.')[0]}Z`;
                    if (eventLocation) qrText += `\nLOCATION:${eventLocation}`;
                    if (eventDescription) qrText += `\nDESCRIPTION:${eventDescription}`;
                    qrText += `\nEND:VEVENT`;
                    break;
            }
            
            // Generate QR code
            const qr = qrcode(0, 'M');
            qr.addData(qrText);
            qr.make();
            
            const canvas = document.getElementById('qrCodeCanvas');
            const ctx = canvas.getContext('2d');
            const size = 250;
            const scale = 10;
            const qrSize = qr.getModuleCount();
            
            canvas.width = size;
            canvas.height = size;
            
            // Clear canvas
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, size, size);
            
            // Draw QR code
            ctx.fillStyle = '#000000';
            for (let row = 0; row < qrSize; row++) {
                for (let col = 0; col < qrSize; col++) {
                    if (qr.isDark(row, col)) {
                        ctx.fillRect(
                            col * scale + (size - qrSize * scale) / 2,
                            row * scale + (size - qrSize * scale) / 2,
                            scale,
                            scale
                        );
                    }
                }
            }
            
            // Show QR code
            document.getElementById('qrCodeDisplay').style.display = 'block';
            document.getElementById('downloadBtn').disabled = false;
            
            // Save QR text for download
            canvas.dataset.qrText = qrText;
            
            showToast('QR code generated!', 'success');
        }
        
        function downloadQRCode() {
            const canvas = document.getElementById('qrCodeCanvas');
            const link = document.createElement('a');
            link.download = `qr_code_${new Date().toISOString().slice(0,10)}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            showToast('QR code saved!', 'success');
        }
        
        // ============ HELPER UI FUNCTIONS ============
        function showAbout() {
            alert(`QR Actions Pro v2.5\n\nA powerful QR code scanner and generator with:\n‚Ä¢ 15+ QR code types detection\n‚Ä¢ Batch scanning mode\n‚Ä¢ QR code generation\n‚Ä¢ Favorites system\n‚Ä¢ Complete offline functionality\n‚Ä¢ Advanced security features\n\nCreated by Bram Diederik\n\nWorks entirely offline - perfect for airplane mode!`);
        }
        
        function showHelp() {
            alert(`üìö QR Actions Pro Help\n\nüîç SCANNING:\n‚Ä¢ Tap "Scan" to use camera\n‚Ä¢ Tap "Upload" to scan from image\n‚Ä¢ Enable "Continuous Scan" in settings for multiple scans\n\nüì¶ BATCH MODE:\n‚Ä¢ Scan multiple QRs without stopping\n‚Ä¢ Great for inventory or collections\n\n‚≠ê FAVORITES:\n‚Ä¢ Tap star icon to save important scans\n‚Ä¢ Access in Favorites tab\n\nüîÑ GENERATE:\n‚Ä¢ Create QR codes for WiFi, contacts, URLs, etc.\n‚Ä¢ Customize all parameters\n\n‚öôÔ∏è SETTINGS:\n‚Ä¢ Configure camera, security, and appearance\n‚Ä¢ Set auto-cleanup rules\n\nAll data is stored locally on your device!`);
        }
        
        function showPrivacy() {
            alert(`üîí Privacy Policy\n\nQR Actions Pro:\n‚Ä¢ Stores ALL data locally on your device\n‚Ä¢ No internet connection required\n‚Ä¢ No data sent to any servers\n‚Ä¢ No tracking or analytics\n‚Ä¢ No ads\n\nYour QR code data never leaves your device!\n\nFor backup/transfer, use the Export feature.`);
        }
        
        // ============ INITIALIZATION ============
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            render();
            updateStats();
            getCameras();
            
            // Initialize with scan tab
            switchTab('scan');
            
            // Clean old scans on startup
            setTimeout(clearOldScans, 1000);
            
            // Show welcome message on first visit
            if (!localStorage.getItem('firstVisitShown')) {
                setTimeout(() => {
                    showToast('Welcome to QR Actions Pro! üëã', 'info', 4000);
                    localStorage.setItem('firstVisitShown', 'true');
                }, 1000);
            }
        });
        
        // Handle offline/online status
        window.addEventListener('online', () => {
            showToast('You are back online', 'success');
        });
        
        window.addEventListener('offline', () => {
            showToast('Working offline - all features available', 'info');
        });
        
        // Prevent pinch zoom on mobile
        document.addEventListener('gesturestart', function(e) {
            e.preventDefault();
        });
    </script>
</body>
</html>
