<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QR Production Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/instascan/1.0.0/instascan.min.js"></script>
    <style>
        :root { --bg: #0f0f0f; --card: #1e1e1e; --accent: #007bff; --text: #e0e0e0; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 15px; text-align: center; }
        video { width: 100%; max-width: 500px; border-radius: 12px; background: #000; box-shadow: 0 4px 20px rgba(0,0,0,0.5); margin-bottom: 15px; }
        .qr-card { background: var(--card); border: 1px solid #333; padding: 15px; margin: 12px auto; max-width: 450px; border-radius: 10px; text-align: left; }
        .controls { display: flex; justify-content: center; gap: 10px; margin: 15px 0; }
        button { background: var(--accent); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; }
        button:active { opacity: 0.7; }
        input[type="password"] { width: 100%; max-width: 300px; padding: 12px; background: #222; border: 1px solid #444; color: white; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; }
        .data-stream { font-family: "SFMono-Regular", Consolas, monospace; font-size: 0.85em; background: #000; padding: 8px; display: block; border-radius: 4px; overflow-x: auto; color: #00ff00; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <h2 id="title">QR ACTIONS PRO</h2>

    <div id="gate">
        <input type="password" id="pinInput" placeholder="Enter System PIN">
        <button onclick="lockPin()">Initialize System</button>
    </div>

    <div id="interface" class="hidden">
        <video id="webcam"></video>
        
        <div class="controls">
            <button onclick="toggleScanner()" id="scanBtn" style="background: #28a745;">Start Scanner</button>
            <button onclick="resetCache()" style="background: #dc3545;">Clear History</button>
        </div>

        <div id="feed"></div>
    </div>

    <script>
        const STORE_KEY = 'PROD_QR_HISTORY';
        const AUTH_KEY = 'PROD_QR_PIN';
        let activeScanner = null;

        // AUTHENTICATION & INITIALIZATION
        function lockPin() {
            const pin = document.getElementById('pinInput').value;
            if (pin) {
                localStorage.setItem(AUTH_KEY, pin);
                startApp();
            }
        }

        function startApp() {
            if (!localStorage.getItem(AUTH_KEY)) return;
            document.getElementById('gate').classList.add('hidden');
            document.getElementById('interface').classList.remove('hidden');
            refreshFeed();
        }

        // SCANNER ENGINE
        function toggleScanner() {
            if (activeScanner) {
                activeScanner.stop();
                activeScanner = null;
                document.getElementById('scanBtn').innerText = "Start Scanner";
                return;
            }

            activeScanner = new Instascan.Scanner({ video: document.getElementById('webcam'), mirror: false });
            
            activeScanner.addListener('scan', (content) => {
                if (navigator.vibrate) navigator.vibrate(50);
                saveEntry(content);
            });

            Instascan.Camera.getCameras().then(cameras => {
                if (cameras.length > 0) {
                    activeScanner.start(cameras[cameras.length - 1]); // Primary back camera
                    document.getElementById('scanBtn').innerText = "Stop Scanner";
                } else {
                    alert('Optical hardware not found.');
                }
            }).catch(e => console.error("Hardware Error:", e));
        }

        // DATA PERSISTENCE (LocalStorage Production Cache)
        function saveEntry(text) {
            const history = JSON.parse(localStorage.getItem(STORE_KEY) || "[]");
            const entry = { text, id: Date.now(), time: new Date().toLocaleTimeString() };
            history.unshift(entry);
            localStorage.setItem(STORE_KEY, JSON.stringify(history.slice(0, 15)));
            refreshFeed();
        }

        function refreshFeed() {
            const container = document.getElementById('feed');
            const data = JSON.parse(localStorage.getItem(STORE_KEY) || "[]");
            container.innerHTML = data.length ? "" : "<p>System standby. No data logs.</p>";

            data.forEach((item, idx) => {
                const card = document.createElement('div');
                card.className = 'qr-card';
                card.innerHTML = `
                    <div style="font-size: 0.7em; color: #888; margin-bottom: 5px;">${item.time}</div>
                    <code class="data-stream">${item.text}</code>
                    <button onclick="transmit(${idx})" style="width:100%; margin-top:10px; background: #444;">ðŸ“¤ TRANSFER TO KDE</button>
                `;
                container.appendChild(card);
            });
        }

        // DEBIAN/KDE BRIDGE (Matches Bash Listener: Line 1=Data, Line 2=PIN)
        async function transmit(idx) {
            const items = JSON.parse(localStorage.getItem(STORE_KEY));
            const entry = items[idx];
            const pin = localStorage.getItem(AUTH_KEY);

            // Payload Structure for bash: sed -n '2p' will find the PIN
            const payload = `${entry.text}\nPIN: ${pin}`;
            const fileName = `transfer_${Date.now()}.txt`;

            if (navigator.share) {
                try {
                    const file = new File([payload], fileName, { type: 'text/plain' });
                    await navigator.share({
                        files: [file],
                        title: 'Production Data Transfer',
                        text: 'STDOUT stream from QR PRO'
                    });
                } catch (err) {
                    console.error("Transfer aborted", err);
                }
            } else {
                // Production Fallback: Direct Browser Stream
                const blob = new Blob([payload], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                a.click();
                URL.revokeObjectURL(url);
            }
        }

        function resetCache() {
            if (confirm("Purge all production logs?")) {
                localStorage.removeItem(STORE_KEY);
                refreshFeed();
            }
        }

        window.onload = startApp;
    </script>
</body>
</html>
