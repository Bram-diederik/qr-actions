<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QR Actions</title>
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlFSIEFjdGlvbnMiLAogICJzaG9ydF9uYW1lIjogIlFSIEFjdGlvbnMiLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiIzEyMTIxMiIsCiAgInRoZW1lX2NvbG9yIjogIiMxMjEyMTIiLAogICJpY29ucyI6IFt7ICJzcmMiOiAiaHR0cHM6Ly9jZG4taWNvbnMtcG5nLmZsYXRpY29uLmNvbS81MTIvMjQxLzI0MTUyOC5wbmciLCAic2l6ZXMiOiAiNTEyeDUxMiIsICJ0eXBlIjogImltYWdlL3BuZyIgfV0KfQ==">
    
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <style>
        :root { --bg: #121212; --card: #1e1e1e; --accent: #007bff; --green: #28a745; --red: #dc3545; }
        body { background: var(--bg); color: #fff; font-family: -apple-system, sans-serif; margin: 0; padding: 10px; text-align: center; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 10px; max-width: 500px; margin: 0 auto; }
        .settings-icon { font-size: 24px; cursor: pointer; background: none; border: none; color: #888; padding: 10px; }
        #settingsOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; flex-direction: column; justify-content: center; align-items: center; }
        .settings-content { background: #222; padding: 25px; border-radius: 15px; width: 85%; max-width: 320px; border: 1px solid #444; text-align: left; }
        #reader { width: 100%; max-width: 450px; margin: auto; border-radius: 12px; overflow: hidden; background: #000; min-height: 250px; }
        .qr-card { background: var(--card); border: 1px solid #333; padding: 15px; margin: 12px auto; max-width: 450px; border-radius: 10px; text-align: left; position: relative; }
        .btn { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; width: 100%; margin-top: 8px; font-size: 14px; }
        .btn-scan { background: var(--green); margin-bottom: 15px; font-size: 16px; }
        .btn-abort { background: var(--red); margin-bottom: 15px; font-size: 16px; display: none; }
        .btn-delete { position: absolute; top: 10px; right: 10px; background: none; border: none; color: #666; font-size: 20px; cursor: pointer; }
        input, select { padding: 12px; background: #333; color: white; border: 1px solid #555; border-radius: 8px; width: 100%; box-sizing: border-box; margin: 5px 0 15px 0; font-size: 16px; }
        code { background: #000; padding: 4px; color: #0f0; word-break: break-all; border-radius: 4px; font-family: monospace; }
        .wifi-pass { filter: blur(5px); cursor: pointer; }
        .wifi-pass.show { filter: blur(0); }
    </style>
</head>
<body>

    <div class="header">
        <h2 style="margin:0;">üìã QR Actions</h2>
        <button class="settings-icon" onclick="toggleSettings()">‚öôÔ∏è</button>
    </div>

    <div id="settingsOverlay">
        <div class="settings-content">
            <h3 style="margin-top:0;">Settings</h3>
            <label style="font-size: 11px; color: #aaa;">PREFERRED CAMERA</label>
            <select id="cameraSelect"><option value="">Default (Environment)</option></select>
            <label style="font-size: 11px; color: #aaa;">HISTORY LIMIT (0 = UNLIMITED)</label>
            <input type="number" id="limitInput" min="0" value="15">
            <label style="font-size: 11px; color: #aaa;">TRANSMISSION PIN</label>
            <input type="password" id="pinInput" placeholder="Optional PIN">
            <button class="btn" style="background:var(--accent);" onclick="saveSettings()">Save & Close</button>
            <button class="btn" style="background:#600; margin-top:20px;" onclick="clearAllData()">‚ö†Ô∏è Clear All Data</button>
            <button class="btn" style="background:transparent;" onclick="toggleSettings()">Cancel</button>
        </div>
    </div>

    <div id="app">
        <div id="reader"></div>
        <button id="cameraBtn" class="btn btn-scan" onclick="startScan()">üì∑ Scan QR Code</button>
        <button id="abortBtn" class="btn btn-abort" onclick="stopScan()">üõë Stop Scanning</button>
        <div id="history"></div>
    </div>

    <script>
        const AUTH_KEY = 'qr_actions_pin_v2';
        const HIST_KEY = 'qr_actions_history_v2';
        const CAM_KEY = 'qr_actions_camera_id';
        const LIMIT_KEY = 'qr_actions_limit';
        let html5QrCode = null;

        /**
         * SERVICE WORKER: THE OFFLINE ENGINE
         * This script creates a virtual "proxy" that saves the HTML and the QR Library 
         * into the phone's storage. 
         */
        if ('serviceWorker' in navigator) {
            const swCode = `
                const CACHE_NAME = 'qr-actions-v3';
                const ASSETS = [
                    './',
                    './index.html',
                    'https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js'
                ];

                self.addEventListener('install', (event) => {
                    event.waitUntil(
                        caches.open(CACHE_NAME).then((cache) => cache.addAll(ASSETS))
                    );
                    self.skipWaiting();
                });

                self.addEventListener('activate', (event) => {
                    event.waitUntil(clients.claim());
                });

                self.addEventListener('fetch', (event) => {
                    event.respondWith(
                        caches.match(event.request).then((response) => {
                            return response || fetch(event.request);
                        })
                    );
                });
            `;
            const blob = new Blob([swCode], { type: 'application/javascript' });
            navigator.serviceWorker.register(URL.createObjectURL(blob));
        }

        // --- CAMERA & SETTINGS ---
        async function getCameras() {
            try {
                const devices = await Html5Qrcode.getCameras();
                const select = document.getElementById('cameraSelect');
                if (devices && devices.length > 0) {
                    select.innerHTML = '';
                    devices.forEach(device => {
                        const option = document.createElement('option');
                        option.value = device.id;
                        option.text = device.label || `Camera ${select.length + 1}`;
                        if(localStorage.getItem(CAM_KEY) === device.id) option.selected = true;
                        select.appendChild(option);
                    });
                }
            } catch (e) { console.error("Camera listing failed", e); }
        }

        function toggleSettings() {
            const overlay = document.getElementById('settingsOverlay');
            overlay.style.display = (overlay.style.display === 'flex') ? 'none' : 'flex';
            if(overlay.style.display === 'flex') {
                document.getElementById('pinInput').value = localStorage.getItem(AUTH_KEY) || "";
                document.getElementById('limitInput').value = localStorage.getItem(LIMIT_KEY) || "15";
                getCameras();
            }
        }

        function saveSettings() {
            localStorage.setItem(AUTH_KEY, document.getElementById('pinInput').value);
            localStorage.setItem(CAM_KEY, document.getElementById('cameraSelect').value);
            localStorage.setItem(LIMIT_KEY, document.getElementById('limitInput').value);
            toggleSettings();
            render();
        }

        function clearAllData() {
            if(confirm("Permanently delete all data?") && confirm("Are you absolutely sure?")) {
                localStorage.clear();
                location.reload();
            }
        }

        // --- SCANNER LOGIC ---
        async function stopScan() {
            if (html5QrCode) {
                try { await html5QrCode.stop(); } catch(e) {}
                html5QrCode = null;
            }
            document.getElementById('cameraBtn').style.display = 'block';
            document.getElementById('cameraBtn').disabled = false;
            document.getElementById('cameraBtn').innerText = "üì∑ Scan QR Code";
            document.getElementById('abortBtn').style.display = 'none';
        }

        async function startScan() {
            const btn = document.getElementById('cameraBtn');
            const abortBtn = document.getElementById('abortBtn');
            const prefCamId = localStorage.getItem(CAM_KEY);

            btn.disabled = true;
            btn.innerText = "Initializing...";

            html5QrCode = new Html5Qrcode("reader");
            const config = prefCamId ? { deviceId: { exact: prefCamId } } : { facingMode: "environment" };

            try {
                await html5QrCode.start(config, { fps: 15, qrbox: 250 }, (text) => {
                    stopScan().then(() => {
                        if (navigator.vibrate) navigator.vibrate(100);
                        saveScan(text);
                    });
                });
                btn.style.display = 'none';
                abortBtn.style.display = 'block';
            } catch (err) {
                btn.disabled = false;
                btn.innerText = "üì∑ Retry Scanner";
                alert("Camera Error: Usually caused by non-HTTPS connection.");
            }
        }

        // --- DATA MANAGEMENT ---
        function saveScan(text) {
            let history = JSON.parse(localStorage.getItem(HIST_KEY) || "[]");
            history.unshift({ text, date: new Date().toLocaleString(), id: Date.now() });
            const limit = parseInt(localStorage.getItem(LIMIT_KEY) || "15");
            if(limit > 0) history = history.slice(0, limit);
            localStorage.setItem(HIST_KEY, JSON.stringify(history));
            render();
        }

        function deleteItem(id) {
            let history = JSON.parse(localStorage.getItem(HIST_KEY) || "[]");
            history = history.filter(item => item.id !== id);
            localStorage.setItem(HIST_KEY, JSON.stringify(history));
            render();
        }

        function togglePass(id) {
            document.getElementById(id).classList.toggle('show');
        }

        function render() {
            const container = document.getElementById('history');
            let items = JSON.parse(localStorage.getItem(HIST_KEY) || "[]");
            container.innerHTML = items.length ? "" : "<p style='color:#666;'>No scan history.</p>";

            items.forEach((item, idx) => {
                const isUrl = item.text.startsWith('http');
                const isWifi = item.text.startsWith('WIFI:');
                let contentHtml = `<code>${item.text}</code>`;
                
                if (isWifi) {
                    const ssid = item.text.match(/S:([^;]+)/)?.[1] || "SSID";
                    const pass = item.text.match(/P:([^;]+)/)?.[1] || "";
                    contentHtml = `SSID: <b>${ssid}</b><br>Pass: <span id="wifi_${item.id}" class="wifi-pass" onclick="togglePass('wifi_${item.id}')">${pass}</span>`;
                }

                const div = document.createElement('div');
                div.className = 'qr-card';
                div.innerHTML = `
                    <button class="btn-delete" onclick="deleteItem(${item.id})">üóë</button>
                    <div style="font-size:0.7em; color:#666; margin-bottom:5px;">${item.date}</div>
                    <div style="margin-bottom:10px; padding-right: 30px;">${contentHtml}</div>
                    <div style="display:flex; flex-wrap:wrap; gap:8px;">
                        <button class="btn btn-share" style="flex:1;" onclick="shareData(${idx})">Share</button>
                        ${isUrl ? `<a href="${item.text}" target="_blank" class="btn" style="flex:1; background:var(--green); text-decoration:none; text-align:center;">üåê Visit</a>` : ''}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        async function shareData(idx) {
            const items = JSON.parse(localStorage.getItem(HIST_KEY));
            const entry = items[idx];
            const pin = localStorage.getItem(AUTH_KEY);
            const payload = entry.text + (pin ? `\nPIN: ${pin}` : "");
            if (navigator.share) {
                const file = new File([payload], `qr_${Date.now()}.txt`, { type: 'text/plain' });
                try { await navigator.share({ files: [file], title: 'QR Actions' }); } catch (e) {}
            }
        }

        render();
    </script>
</body>
</html>
