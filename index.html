<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QR Actions</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --accent: #007bff; --green: #28a745; --red: #dc3545; }
        body { background: var(--bg); color: #fff; font-family: -apple-system, sans-serif; margin: 0; padding: 10px; text-align: center; }
        #reader { width: 100%; max-width: 450px; margin: auto; border-radius: 12px; overflow: hidden; background: #000; }
        .qr-card { background: var(--card); border: 1px solid #333; padding: 15px; margin: 12px auto; max-width: 450px; border-radius: 10px; text-align: left; }
        .btn { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; width: 100%; margin-top: 8px; font-size: 14px; }
        .btn-share { background: var(--accent); }
        .btn-scan { background: var(--green); margin-bottom: 15px; }
        .btn-sec { background: #555; font-size: 12px; }
        input { padding: 12px; background: #333; color: white; border: 1px solid #555; border-radius: 8px; width: 90%; margin: 10px 0; }
        .hidden { display: none; }
        code { background: #000; padding: 4px; color: #0f0; word-break: break-all; border-radius: 4px; }
        .footer { margin-top: 30px; padding: 20px; border-top: 1px solid #333; font-size: 14px; }
        .footer a { color: var(--accent); text-decoration: none; margin: 0 10px; }
        .settings-panel { background: #252525; padding: 15px; border-radius: 10px; margin-bottom: 15px; }
        .wifi-pass { filter: blur(5px); transition: filter 0.3s; cursor: pointer; }
        .wifi-pass.show { filter: blur(0); }
    </style>
</head>
<body>

    <h1>üìã QR Actions</h1>

    <div id="settings" class="settings-panel">
        <div id="pinStatus">PIN: <span id="currentPinStatus">None</span></div>
        <input type="password" id="pinInput" placeholder="Set PIN (Leave empty to disable)">
        <button class="btn btn-sec" onclick="updateSettings()">Update Settings</button>
    </div>

    <div id="app">
        <div id="reader"></div>
        <button id="cameraBtn" class="btn btn-scan" onclick="startScan()">üì∑ Scan QR Code</button>
        <div id="history"></div>
    </div>

    <div class="footer">
        By <strong>Bram Diederik</strong><br>
        <a href="about.html">About</a> | 
        <a href="autoconnect.html">Auto Connect Laptop</a>
    </div>

    <script>
        const AUTH_KEY = 'qr_actions_pin';
        const HIST_KEY = 'qr_actions_history';
        let html5QrCode = null;

        /** * Settings & PIN Logic
         * PIN is now optional. If set, it's appended to Line 2 of shared files.
         */
        function updateSettings() {
            const val = document.getElementById('pinInput').value;
            localStorage.setItem(AUTH_KEY, val);
            loadSettings();
            alert("Settings updated.");
        }

        function loadSettings() {
            const pin = localStorage.getItem(AUTH_KEY);
            document.getElementById('currentPinStatus').innerText = pin ? "Active" : "Disabled";
            document.getElementById('pinInput').value = pin || "";
        }

        /**
         * One-Shot Scan Logic
         */
        function startScan() {
            const btn = document.getElementById('cameraBtn');
            btn.disabled = true;
            btn.innerText = "Camera Opening...";

            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: 250 }, (text) => {
                html5QrCode.stop().then(() => {
                    html5QrCode = null;
                    btn.disabled = false;
                    btn.innerText = "üì∑ Scan QR Code";
                    if (navigator.vibrate) navigator.vibrate(100);
                    saveScan(text);
                });
            }).catch(err => {
                btn.disabled = false;
                btn.innerText = "üì∑ Retry Scanner";
                console.error(err);
            });
        }

        function saveScan(text) {
            let history = JSON.parse(localStorage.getItem(HIST_KEY) || "[]");
            history.unshift({ text, date: new Date().toLocaleString(), id: Date.now() });
            localStorage.setItem(HIST_KEY, JSON.stringify(history.slice(0, 15)));
            render();
        }

        /**
         * Security Check (VirusTotal Integration)
         */
        function checkSafety(url) {
            const vtUrl = `https://www.virustotal.com/gui/search/${encodeURIComponent(url)}`;
            window.open(vtUrl, '_blank');
        }

        /**
         * Wifi Password Masking Toggle
         */
        function togglePass(id) {
            document.getElementById(id).classList.toggle('show');
        }

        function render() {
            const container = document.getElementById('history');
            const items = JSON.parse(localStorage.getItem(HIST_KEY) || "[]");
            container.innerHTML = items.length ? "" : "<p>No history available.</p>";

            items.forEach((item, idx) => {
                const isUrl = item.text.startsWith('http');
                const isWifi = item.text.startsWith('WIFI:');
                let displayText = `<code>${item.text}</code>`;
                
                if (isWifi) {
                    // Pre-parse WiFi for the "Show" option
                    const ssid = item.text.match(/S:([^;]+)/)?.[1] || "Unknown";
                    const pass = item.text.match(/P:([^;]+)/)?.[1] || "";
                    displayText = `SSID: <b>${ssid}</b><br>Pass: <span id="wifi_${item.id}" class="wifi-pass" onclick="togglePass('wifi_${item.id}')">${pass || 'None'}</span> (Tap to show)`;
                }

                const div = document.createElement('div');
                div.className = 'qr-card';
                div.innerHTML = `
                    <div style="font-size:0.75em; color:#888;">${item.date}</div>
                    <div style="margin:8px 0;">${displayText}</div>
                    ${isUrl ? `<button class="btn btn-sec" onclick="checkSafety('${item.text}')">üõ°Ô∏è Check Security</button>` : ''}
                    <button class="btn btn-share" onclick="shareData(${idx})">üì§ Share</button>
                `;
                container.appendChild(div);
            });
        }

        /**
         * Generic Share (Legacy KDE compatibility)
         */
        async function shareData(idx) {
            const items = JSON.parse(localStorage.getItem(HIST_KEY));
            const entry = items[idx];
            const pin = localStorage.getItem(AUTH_KEY);

            // Format: Line 1 = Data, Line 2 = PIN (if exists)
            const payload = entry.text + (pin ? `\nPIN: ${pin}` : "");
            const fileName = `qr_actions_${Date.now()}.txt`;

            if (navigator.share) {
                try {
                    const file = new File([payload], fileName, { type: 'text/plain' });
                    await navigator.share({ files: [file], title: 'QR Actions Share' });
                } catch (e) {}
            } else {
                const blob = new Blob([payload], { type: 'text/plain' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = fileName;
                a.click();
            }
        }

        loadSettings();
        render();
    </script>
</body>
</html>
