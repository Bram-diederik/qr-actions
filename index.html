<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QR Production Dashboard</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { background: #111; color: white; font-family: sans-serif; text-align: center; margin: 0; padding: 10px; }
        #reader { width: 100%; max-width: 500px; margin: auto; border-radius: 10px; overflow: hidden; }
        .qr-item { background: #222; border: 1px solid #444; margin: 10px auto; padding: 15px; border-radius: 10px; max-width: 450px; text-align: left; }
        .btn { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; width: 100%; margin-top: 10px; }
        .btn-share { background: #007bff; }
        .btn-start { background: #28a745; margin-bottom: 15px; }
        input[type="password"] { padding: 12px; background: #333; border: 1px solid #555; color: white; border-radius: 8px; width: 90%; margin: 10px 0; }
        .hidden { display: none; }
        code { background: #000; padding: 4px; color: #0f0; word-break: break-all; }
    </style>
</head>
<body>

    <h1>ðŸ“‹ QR Dashboard</h1>

    <div id="gate">
        <input type="password" id="pinInput" placeholder="Voer PIN in (e.g. 2626)">
        <button class="btn btn-start" onclick="initApp()">Set PIN & Start</button>
    </div>

    <div id="app" class="hidden">
        <div id="reader"></div>
        <button id="cameraBtn" class="btn btn-start" onclick="toggleCamera()">ðŸ“· Start Scanner</button>
        <div id="history"></div>
    </div>

    <script>
        const AUTH_KEY = 'qr_prod_pin';
        const HIST_KEY = 'qr_prod_history';
        let scanner = null;

        /**
         * INITIALIZATION
         */
        function initApp() {
            const pin = document.getElementById('pinInput').value;
            if (pin) {
                localStorage.setItem(AUTH_KEY, pin);
                document.getElementById('gate').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                render();
            }
        }

        /**
         * CAMERA LOGIC (Production Fix)
         */
        function toggleCamera() {
            if (scanner) {
                scanner.stop().then(() => {
                    scanner = null;
                    document.getElementById('cameraBtn').innerText = "ðŸ“· Start Scanner";
                });
                return;
            }

            scanner = new Html5Qrcode("reader");
            const config = { fps: 15, qrbox: { width: 250, height: 250 } };

            // Request back camera explicitly
            scanner.start({ facingMode: "environment" }, config, (text) => {
                if (navigator.vibrate) navigator.vibrate(100);
                saveScan(text);
            }).catch(err => {
                alert("Camera fail: Check HTTPS or Permissions.");
                console.error(err);
            });

            document.getElementById('cameraBtn').innerText = "ðŸ›‘ Stop Scanner";
        }

        /**
         * DATA MANAGEMENT
         */
        function saveScan(text) {
            let history = JSON.parse(localStorage.getItem(HIST_KEY) || "[]");
            history.unshift({ text, date: new Date().toLocaleString() });
            localStorage.setItem(HIST_KEY, JSON.stringify(history.slice(0, 10)));
            render();
        }

        function render() {
            const container = document.getElementById('history');
            const items = JSON.parse(localStorage.getItem(HIST_KEY) || "[]");
            container.innerHTML = items.length ? "" : "<p>Geen QR codes gevonden.</p>";

            items.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'qr-item';
                div.innerHTML = `
                    <div><b>Tijd:</b> ${item.date}</div>
                    <div><b>QR:</b> <code>${item.text}</code></div>
                    <button class="btn btn-share" onclick="sendToKde(${idx})">ðŸ“¤ Delen naar KDE</button>
                `;
                container.appendChild(div);
            });
        }

        /**
         * BASH LISTENER BRIDGE
         * Line 1: Data (URL/WIFI)
         * Line 2: PIN: XXXX
         */
        async function sendToKde(idx) {
            const items = JSON.parse(localStorage.getItem(HIST_KEY));
            const entry = items[idx];
            const pin = localStorage.getItem(AUTH_KEY);

            const payload = `${entry.text}\nPIN: ${pin}`;
            const fileName = `qr_share_${Date.now()}.txt`;

            if (navigator.share) {
                try {
                    const file = new File([payload], fileName, { type: 'text/plain' });
                    await navigator.share({ files: [file], title: 'QR Data' });
                } catch (e) { /* Cancelled */ }
            } else {
                const blob = new Blob([payload], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                a.click();
                URL.revokeObjectURL(url);
            }
        }

        // Auto-check on load
        if (localStorage.getItem(AUTH_KEY)) {
            document.getElementById('gate').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            render();
        }
    </script>
</body>
</html>
