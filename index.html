<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QR Actions</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --accent: #007bff; --green: #28a745; }
        body { background: var(--bg); color: #fff; font-family: -apple-system, sans-serif; margin: 0; padding: 10px; text-align: center; }
        
        /* Header & Settings Icon */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 10px; max-width: 500px; margin: 0 auto; }
        .settings-icon { font-size: 24px; cursor: pointer; background: none; border: none; color: #888; }
        
        /* Settings Overlay */
        #settingsOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; flex-direction: column; justify-content: center; align-items: center; }
        .settings-content { background: #222; padding: 30px; border-radius: 15px; width: 80%; max-width: 300px; border: 1px solid #444; }

        #reader { width: 100%; max-width: 450px; margin: auto; border-radius: 12px; overflow: hidden; background: #000; }
        .qr-card { background: var(--card); border: 1px solid #333; padding: 15px; margin: 12px auto; max-width: 450px; border-radius: 10px; text-align: left; }
        
        .btn { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; width: 100%; margin-top: 8px; }
        .btn-share { background: var(--accent); }
        .btn-scan { background: var(--green); margin-bottom: 15px; font-size: 16px; }
        .btn-sec { background: #444; font-size: 12px; }
        
        input { padding: 12px; background: #333; color: white; border: 1px solid #555; border-radius: 8px; width: 100%; box-sizing: border-box; margin: 10px 0; }
        code { background: #000; padding: 4px; color: #0f0; word-break: break-all; border-radius: 4px; }
        
        /* WiFi Masking */
        .wifi-pass { filter: blur(5px); transition: filter 0.3s; cursor: pointer; background: #333; padding: 2px 6px; border-radius: 4px; }
        .wifi-pass.show { filter: blur(0); }

        .footer { margin-top: 40px; padding: 20px; border-top: 1px solid #333; font-size: 14px; color: #888; }
        .footer a { color: var(--accent); text-decoration: none; margin: 0 10px; }
    </style>
</head>
<body>

    <div class="header">
        <h2 style="margin:0;">üìã QR Actions</h2>
        <button class="settings-icon" onclick="toggleSettings()">‚öôÔ∏è</button>
    </div>

    <div id="settingsOverlay">
        <div class="settings-content">
            <h3>Settings</h3>
            <label style="font-size: 12px;">Transmission PIN (Optional)</label>
            <input type="password" id="pinInput" placeholder="e.g. 2626">
            <button class="btn btn-share" onclick="saveSettings()">Save & Close</button>
            <button class="btn" style="background:transparent;" onclick="toggleSettings()">Cancel</button>
        </div>
    </div>

    <div id="app">
        <div id="reader"></div>
        <button id="cameraBtn" class="btn btn-scan" onclick="startScan()">üì∑ Scan QR Code</button>
        <div id="history"></div>
    </div>

    <div class="footer">
        By <strong>Bram Diederik</strong><br><br>
        <a href="about.html">About</a> | 
        <a href="autoconnect.html">Auto Connect Laptop</a>
    </div>

    <script>
        const AUTH_KEY = 'qr_actions_pin_v2';
        const HIST_KEY = 'qr_actions_history_v2';
        let html5QrCode = null;

        function toggleSettings() {
            const overlay = document.getElementById('settingsOverlay');
            overlay.style.display = (overlay.style.display === 'flex') ? 'none' : 'flex';
            if(localStorage.getItem(AUTH_KEY)) {
                document.getElementById('pinInput').value = localStorage.getItem(AUTH_KEY);
            }
        }

        function saveSettings() {
            const val = document.getElementById('pinInput').value;
            localStorage.setItem(AUTH_KEY, val);
            toggleSettings();
        }

        function startScan() {
            const btn = document.getElementById('cameraBtn');
            btn.disabled = true;
            btn.innerText = "Initializing Camera...";

            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: 250 }, (text) => {
                // One-shot scan: stop immediately
                html5QrCode.stop().then(() => {
                    html5QrCode = null;
                    btn.disabled = false;
                    btn.innerText = "üì∑ Scan QR Code";
                    if (navigator.vibrate) navigator.vibrate(100);
                    saveScan(text);
                });
            }).catch(err => {
                btn.disabled = false;
                btn.innerText = "üì∑ Retry Scanner";
                alert("Camera Access Denied or HTTP used.");
            });
        }

        function saveScan(text) {
            let history = JSON.parse(localStorage.getItem(HIST_KEY) || "[]");
            history.unshift({ text, date: new Date().toLocaleString(), id: Date.now() });
            localStorage.setItem(HIST_KEY, JSON.stringify(history.slice(0, 15)));
            render();
        }

function checkSafety(urlToTest) {
    // 1. Clean the URL
    const cleanUrl = urlToTest.trim();
    
    // 2. Base64 Encode and remove the '=' padding as per VT API specs
    const encodedUrl = btoa(cleanUrl).replace(/=/g, "");
    
    // 3. Construct the direct report URL
    const vtUrl = `https://www.virustotal.com/gui/url/${encodedUrl}/detection`;
    
    // 4. Open in a new tab
    window.open(vtUrl, '_blank');
}

        function togglePass(id) {
            document.getElementById(id).classList.toggle('show');
        }

        function render() {
            const container = document.getElementById('history');
            const items = JSON.parse(localStorage.getItem(HIST_KEY) || "[]");
            container.innerHTML = items.length ? "" : "<p style='color:#666;'>No scan history.</p>";

            items.forEach((item, idx) => {
                const isUrl = item.text.startsWith('http');
                const isWifi = item.text.startsWith('WIFI:');
                let contentHtml = `<code>${item.text}</code>`;
                
                if (isWifi) {
                    const ssid = item.text.match(/S:([^;]+)/)?.[1] || "SSID";
                    const pass = item.text.match(/P:([^;]+)/)?.[1] || "";
                    contentHtml = `SSID: <b>${ssid}</b><br>Pass: <span id="wifi_${item.id}" class="wifi-pass" onclick="togglePass('wifi_${item.id}')">${pass}</span>`;
                }

                const div = document.createElement('div');
                div.className = 'qr-card';
                div.innerHTML = `
                    <div style="font-size:0.7em; color:#666; margin-bottom:5px;">${item.date}</div>
                    <div style="margin-bottom:10px;">${contentHtml}</div>
                    <div style="display:flex; gap:8px;">
                        <button class="btn btn-share" onclick="shareData(${idx})">Share</button>
                        ${isUrl ? `<button class="btn btn-sec" onclick="checkSafety('${item.text}')">üõ°Ô∏è Security Check</button>` : ''}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        async function shareData(idx) {
            const items = JSON.parse(localStorage.getItem(HIST_KEY));
            const entry = items[idx];
            const pin = localStorage.getItem(AUTH_KEY);

            // Correct format for your Debian listener (Line 1: Data, Line 2: PIN)
            const payload = entry.text + (pin ? `\nPIN: ${pin}` : "");
            const fileName = `qr_actions_${Date.now()}.txt`;

            if (navigator.share) {
                try {
                    const file = new File([payload], fileName, { type: 'text/plain' });
                    await navigator.share({ files: [file], title: 'QR Actions' });
                } catch (e) {}
            } else {
                const blob = new Blob([payload], { type: 'text/plain' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = fileName;
                a.click();
            }
        }

        render();
    </script>
</body>
</html>
