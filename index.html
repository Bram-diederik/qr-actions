<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QR actions</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --accent: #007bff; --green: #28a745; --red: #dc3545; --orange: #fd7e14; --grey: #444; }
        body { background: var(--bg); color: #fff; font-family: -apple-system, sans-serif; margin: 0; padding: 10px; display: flex; flex-direction: column; min-height: 100vh; }
        #authOverlay { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .pin-pad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px; }
        .pin-btn { width: 60px; height: 60px; border-radius: 50%; border: 1px solid #444; background: #222; color: white; font-size: 20px; font-weight: bold; cursor: pointer; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 10px; max-width: 500px; margin: 0 auto; width: 100%; }
        #settingsOverlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; flex-direction: column; align-items: center; justify-content: center; }
        .settings-content { background: #222; padding: 25px; border-radius: 15px; width: 85%; max-width: 350px; border: 1px solid #444; max-height: 80vh; overflow-y: auto; }
        #reader { width: 100%; max-width: 450px; margin: auto; border-radius: 12px; overflow: hidden; background: #000; min-height: 250px; }
        .btn { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; width: 100%; margin-top: 8px; display: inline-flex; align-items: center; justify-content: center; text-decoration: none; font-size: 14px; box-sizing: border-box; }
        .qr-card { background: var(--card); border: 1px solid #333; padding: 15px; margin: 12px auto; max-width: 450px; border-radius: 10px; position: relative; text-align: left; }
        .inspect-box { background: #111; border-left: 3px solid var(--accent); padding: 10px; margin-top: 10px; font-size: 13px; border-radius: 4px; overflow-wrap: break-word; line-height: 1.6; }
        code { background: #000; padding: 8px; color: #0f0; word-break: break-all; border-radius: 4px; display: block; margin: 10px 0; font-family: monospace; font-size: 11px; white-space: pre-wrap; }
        input { padding: 12px; background: #333; color: white; border: 1px solid #555; border-radius: 8px; width: 100%; box-sizing: border-box; margin-bottom: 8px; }
        .tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; text-transform: uppercase; margin-bottom: 5px; }
        .act-link { color: var(--accent); text-decoration: underline; cursor: pointer; display: block; margin-bottom: 6px; font-size: 14px; }
        .del-btn { position: absolute; top: 10px; right: 10px; background: #333; border: 1px solid #444; color: var(--red); border-radius: 4px; padding: 4px 8px; font-size: 11px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="authOverlay">
        <h2>üîí Vault Locked</h2>
        <div id="pinDisplay" style="font-size: 30px; letter-spacing: 10px; height: 40px; margin: 20px 0;"></div>
        <div class="pin-pad" id="pinPad"></div>
        <button class="btn" style="background:#600; width:auto; margin-top:20px;" onclick="nuke(false)">Nuke Data</button>
    </div>

    <div id="app" style="display:none;">
        <div class="header">
            <h2 style="margin:0;">üìã QR actions</h2>
            <button onclick="toggleSettings()" style="background:none; border:none; font-size:24px; cursor:pointer;">‚öôÔ∏è</button>
        </div>

        <div id="settingsOverlay">
            <div class="settings-content">
                <h3 style="margin-top:0;">Settings</h3>
                <label>VAULT PIN (8 Digits)</label>
                <input type="password" id="vPin1" placeholder="New PIN">
                <label>STATION PIN</label>
                <input type="text" id="bPin" placeholder="Station Script PIN">
                <label>HISTORY LIMIT</label>
                <input type="number" id="hLimit" placeholder="15">
                
                <hr style="border:0; border-top:1px solid #444; margin:15px 0;">
                <label>REGRESSION TOOLS</label>
                <button class="btn" style="background:var(--orange);" onclick="forceRandomDownload()">üé≤ Force file&lt;timestamp&gt; Junk</button>
                
                <button class="btn" style="background:var(--accent); margin-top:20px;" onclick="saveSettings()">Save & Close</button>
                <button class="btn" style="background:transparent;" onclick="toggleSettings()">Cancel</button>
            </div>
        </div>

        <div id="reader"></div>
        <button id="stopBtn" class="btn" style="display:none; background:var(--red);" onclick="stopScan()">üõë Stop Scanning</button>

        <div style="display:flex; gap:10px; max-width:450px; margin: 10px auto;">
            <button class="btn" style="background:var(--green); flex:2;" onclick="startScan()">üì∑ Scan</button>
            <div class="btn" style="background:var(--grey); flex:1; position:relative; overflow:hidden;">üìÅ Upload<input type="file" style="position:absolute; inset:0; opacity:0;" onchange="upload(event)"></div>
        </div>
        
        <div id="history"></div>
    </div>

    <script>
        /**
         * QR ACTIONS - COMPREHENSIVE MANIFEST (v5.5)
         * --------------------------------------------------
         * 1. APPLICATION IDENTITY:
         * - Name: "QR actions" (UI/Header/Title).
         * - Storage Filename: bluetooth_content_share.html (Debian Target).
         * * 2. DATA EXPORT SPECIFICATION:
         * - ALL exported files MUST strictly follow the naming convention: file<timestamp>.<extension>
         * - Example: file1700000000000.vcf
         * * 3. SUPPORTED PROTOCOLS:
         * - vCard (BEGIN:VCARD): Multi-field parsing & .vcf export.
         * - Event (BEGIN:VEVENT): Calendar integration & .ics export.
         * - Crypto: Auto-detect Bitcoin/Ethereum with Explorer links.
         * - Communication: tel:, mailto:, sms: direct triggers.
         * - Geo: geo: coords with Google/OSM map search links.
         * - WiFi: WIFI: format with masked PW and "Show/Copy" logic.
         * * 4. SECURITY & PERSISTENCE:
         * - 8-digit mandatory Vault PIN.
         * - LocalStorage persistence (Auth, History, Settings).
         * - Nuke function for full data sanitization.
         */

        const HIST_KEY = 'qr_history';
        const AUTH_KEY = 'qr_auth_pin';
        const BT_KEY = 'qr_bt_pin';
        const LIM_KEY = 'qr_hist_limit';

        let tempPin = "";
        let html5QrCode = null;

        /** FORCE file<timestamp> JUNK DOWNLOAD **/
        function forceRandomDownload() {
            const ts = Date.now();
            const fileName = `file${ts}.bin`;
            const junk = "DEBIAN_REGRESSION_TEST_" + Math.random().toString(36).substring(2, 15);
            downloadFile(junk, fileName, 'application/octet-stream');
        }

        function getQRType(t) {
            if (t.startsWith('http')) return { type: 'URL', icon: 'üîó' };
            if (t.includes('BEGIN:VCARD')) return { type: 'VCARD', icon: 'üë§' };
            if (t.includes('BEGIN:VEVENT')) return { type: 'EVENT', icon: 'üìÖ' };
            if (t.startsWith('WIFI:')) return { type: 'WIFI', icon: 'üì∂' };
            if (t.startsWith('geo:')) return { type: 'GEO', icon: 'üìç' };
            if (t.startsWith('tel:')) return { type: 'PHONE', icon: 'üìû' };
            if (t.startsWith('mailto:')) return { type: 'EMAIL', icon: '‚úâÔ∏è' };
            if (t.startsWith('sms:')) return { type: 'SMS', icon: 'üí¨' };
            if (t.startsWith('bitcoin:') || /^[13][a-km-zA-HJ-NP-Z1-9]{25,34}$/.test(t)) return { type: 'BITCOIN', icon: '‚Çø' };
            if (t.startsWith('ethereum:') || /^0x[a-fA-F0-9]{40}$/.test(t)) return { type: 'ETHEREUM', icon: '‚ô¶' };
            return { type: 'TEXT', icon: 'üìÑ' };
        }

        function parseActions(text, info, id) {
            let html = `<span class="tag" style="background:var(--accent)">${info.icon} ${info.type}</span><br>`;
            const ts = Date.now();
            
            if (info.type === 'VCARD') {
                html += `<button class="btn" style="background:var(--green)" onclick="downloadFile('${text.replace(/\n/g, '\\n')}', 'file${ts}.vcf', 'text/vcard')">üíæ Save vCard (file${ts})</button>`;
            } else if (info.type === 'EVENT') {
                html += `<button class="btn" style="background:var(--accent)" onclick="downloadFile('${text.replace(/\n/g, '\\n')}', 'file${ts}.ics', 'text/calendar')">üìÖ Save Event (file${ts})</button>`;
            } else if (info.type === 'WIFI') {
                const pass = text.match(/P:(.*?);/)?.[1] || "";
                html += `<button class="btn" style="background:var(--grey)" onclick="copy('${pass.replace(/'/g,"\\'")}')">üìã Copy Password</button>`;
            } else if (info.type === 'URL') {
                html += `<a href="${text}" target="_blank" class="act-link">${text}</a>`;
            } else if (info.type === 'BITCOIN' || info.type === 'ETHEREUM') {
                const addr = text.replace(/bitcoin:|ethereum:/, '');
                html += `<button class="btn" style="background:var(--orange)" onclick="copy('${addr}')">üìã Copy Address</button>`;
            } else {
                html += `<div class="inspect-box">${text}</div>`;
            }
            return html;
        }

        /** UTILITIES **/
        function maskSensitive(t) { return t.startsWith('WIFI:') ? t.replace(/P:.*?;/, 'P:********;') : t; }
        function copy(t) { navigator.clipboard.writeText(t); alert("Copied!"); }
        function downloadFile(raw, filename, mime) {
            const blob = new Blob([raw.replace(/\\n/g, '\n')], { type: mime });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
            URL.revokeObjectURL(url);
        }

        /** CORE RENDER **/
        function render() {
            const container = document.getElementById('history');
            const items = JSON.parse(localStorage.getItem(HIST_KEY) || "[]");
            container.innerHTML = items.length ? "" : "<p style='text-align:center;color:#666'>History Empty</p>";
            items.forEach(item => {
                const info = getQRType(item.text);
                const div = document.createElement('div');
                div.className = 'qr-card';
                div.innerHTML = `
                    <button class="del-btn" onclick="del(${item.id})">DELETE</button>
                    <small style="color:#888">${item.date}</small>
                    <code>${maskSensitive(item.text)}</code>
                    ${parseActions(item.text, info, item.id)}`;
                container.appendChild(div);
            });
        }

        function save(text) {
            let h = JSON.parse(localStorage.getItem(HIST_KEY) || "[]");
            h.unshift({ text, date: new Date().toLocaleString(), id: Date.now() });
            localStorage.setItem(HIST_KEY, JSON.stringify(h.slice(0, 20)));
            render();
        }

        function del(id) {
            const h = JSON.parse(localStorage.getItem(HIST_KEY) || "[]").filter(i => i.id !== id);
            localStorage.setItem(HIST_KEY, JSON.stringify(h)); render();
        }

        function nuke(f) { if(f || confirm("Wipe all data?")) { localStorage.clear(); location.reload(); } }

        /** AUTHPAD **/
        function unlock() { document.getElementById('authOverlay').style.display = 'none'; document.getElementById('app').style.display = 'block'; render(); }
        function checkAuth() { 
            const pin = localStorage.getItem(AUTH_KEY); 
            if(pin) { document.getElementById('authOverlay').style.display = 'flex'; renderPinPad(); } 
            else unlock(); 
        }
        function renderPinPad() {
            const pad = document.getElementById('pinPad'); pad.innerHTML = "";
            [1,2,3,4,5,6,7,8,9,'C',0,'OK'].forEach(v => {
                const b = document.createElement('button'); b.className = 'pin-btn'; b.innerText = v;
                b.onclick = () => {
                    if(v === 'C') tempPin = "";
                    else if(v === 'OK') { if(tempPin === localStorage.getItem(AUTH_KEY)) unlock(); else tempPin = ""; }
                    else if(tempPin.length < 8) tempPin += v;
                    document.getElementById('pinDisplay').innerText = "*".repeat(tempPin.length);
                };
                pad.appendChild(b);
            });
        }

        /** SCANNING **/
        async function startScan() {
            if (html5QrCode) await html5QrCode.stop();
            document.getElementById('stopBtn').style.display = 'block';
            html5QrCode = new Html5Qrcode("reader");
            await html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: 250 }, (t) => { stopScan(); save(t); });
        }
        function stopScan() { if(html5QrCode) html5QrCode.stop(); document.getElementById('stopBtn').style.display = 'none'; }
        function upload(e) {
            const f = e.target.files[0]; if(!f) return;
            const s = new Html5Qrcode("reader");
            s.scanFile(f, true).then(t => { save(t); s.clear(); });
        }

        function toggleSettings() { const s = document.getElementById('settingsOverlay'); s.style.display = s.style.display === 'flex' ? 'none' : 'flex'; }
        function saveSettings() {
            const p = document.getElementById('vPin1').value; if(p) localStorage.setItem(AUTH_KEY, p);
            localStorage.setItem(BT_KEY, document.getElementById('bPin').value);
            toggleSettings(); checkAuth();
        }

        checkAuth();
    </script>
</body>
</html>
